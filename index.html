<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Corvo de Hekate</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cinzel, Lato, Merriweather -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- GSAP & SplitType for Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/split-type@0.3.4/umd/index.min.js"></script>
    <style>
        /* Paleta Mística de Hekate:
           Base: Preto profundo (#0a0a0a)
           Primária: Roxo escuro/místico (#4a148c, #38006b)
           Secundária: Cinza escuro (#1a1a1a, #212121)
           Acento (Tochas): Âmbar/Dourado escuro (#b45309, #f59e0b)
           Texto: Cinza claro (#e5e5e5), Branco (#f9f9f9)
        */
        body {
            font-family: 'Lato', sans-serif;
            background-color: #0a0a0a;
            color: #e5e5e5;
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png');
            overflow: hidden; /* Prevent scrollbars during intro */
        }
        .title-font {
            font-family: 'Cinzel', serif;
        }
        .body-font {
            font-family: 'Merriweather', serif;
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(245, 158, 11, 0.4); /* Brilho de tocha */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a148c; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #38006b; }
        
        .form-input {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid #4a148c;
            color: #f3f4f6;
            border-radius: 0.375rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5), inset 0 0 5px rgba(245, 158, 11, 0.2);
        }
        .btn-primary {
            background: linear-gradient(145deg, #4a148c, #38006b);
            color: #e5e5e5;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 20, 140, 0.2);
            border: 1px solid #6a1b9a;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 20, 140, 0.4);
        }
        .btn-primary:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-accent {
            background: linear-gradient(145deg, #f59e0b, #b45309);
            color: #1a1a1a;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
            border: 1px solid #d97706;
        }
        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        .btn-secondary {
            background-color: #4a4a4a;
            color: #e5e5e5;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #5a5a5a;
            transform: translateY(-2px);
        }

        .view-container { 
            display: none; 
            animation: fadeIn 0.5s ease-in-out;
            min-height: 80vh;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Formatação de Conteúdo */
        .highlight { color: #fde68a; font-style: italic; } /* Amarelo claro */
        .mystic-term { color: #d8b4fe; font-weight: 600; text-shadow: 0 0 6px rgba(216, 180, 254, 0.5); } /* Roxo claro */

        /* Estilo para links de navegação */
        .nav-link {
            cursor: pointer;
            padding: 0.5rem 0; /* Adiciona padding para toque mobile */
        }

        /* Intro Animation Styles */
        #intro-sequence {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            /* MUDANÇA: Fundo branco para mesclar com o vídeo */
            background: #fff; 
            z-index: 100;
            display: grid; 
            place-items: center; 
        }
        /* REMOVIDO: .intro-heading e .intro-logo-img não são mais necessários */
        
        /* Estilo para Checkbox no Modal de Aluno */
        .student-section-label {
            display: block;
            padding: 0.75rem 1rem;
            background-color: #2a2a2a;
            border: 1px solid #4a148c;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .student-section-label:hover {
            background-color: #3a3a3a;
        }
        .student-section-label input {
            margin-right: 0.75rem;
            accent-color: #f59e0b;
        }
        
        /* Audio Player Styles */
        .audio-playing {
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
            border-color: #f59e0b;
        }

    </style>
</head>
<body class="bg-black text-gray-200">

    <!-- Intro Section -->
    <div id="intro-sequence">
        <!-- Wrapper para controlar o tamanho máximo do vídeo -->
        <div style="width: 100%; max-width: 1024px; min-width: 300px;"> 
            <!-- Div do Vimeo para manter o aspect ratio 16:9 -->
            <div style="padding:56.25% 0 0 0;position:relative;">
                <iframe 
                    src="https://player.vimeo.com/video/1136095667?badge=0&autopause=0&player_id=0&app_id=58479&autoplay=1&muted=1&controls=0&title=0&byline=0&portrait=0" 
                    frameborder="0" 
                    allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share" 
                    referrerpolicy="strict-origin-when-cross-origin" 
                    style="position:absolute;top:0;left:0;width:100%;height:100%;" 
                    title="Intro Logo Corvo de Hekate">
                </iframe>
            </div>
        </div>
    </div>

    <div id="app-root" style="display: none;">
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
        </div>

        <!-- Header e Navegação Principal -->
        <header class="bg-gray-900 bg-opacity-80 backdrop-blur-sm shadow-md border-b-2 border-purple-800 p-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center">
                <img src="https://i.ibb.co/2705r709/Black-Friday.png" alt="Logo O Corvo de Hekate" class="h-12 w-12 mr-3 object-contain" onerror="this.style.display='none'">
                <h1 class="text-xl sm:text-2xl font-bold text-white title-font hidden md:block">O Corvo de Hekate</h1>
            </div>
            <nav class="hidden md:flex items-center space-x-6">
                <!-- Botões internos usam data-view -->
                <button data-view="home-view" class="internal-link nav-link text-gray-300 hover:text-amber-400 transition title-font">Início</button>
                <button data-view="blog-view" class="internal-link nav-link text-gray-300 hover:text-amber-400 transition title-font">Blog</button>
                <button data-view="sobre-view" class="internal-link nav-link text-gray-300 hover:text-amber-400 transition title-font">Sobre Mim</button>
                <!-- Links externos usam <a> -->
                <a href="https://ardanraven.github.io/Calendario/" target="_blank" rel="noopener noreferrer" class="nav-link text-gray-300 hover:text-amber-400 transition title-font">Calendário</a>
                <a href="https://caminhodatocha.site" target="_blank" rel="noopener noreferrer" class="nav-link text-gray-300 hover:text-amber-400 transition title-font">Mentoria</a>
            </nav>
            <div>
                <div id="user-info" class="hidden items-center">
                    <span id="user-email" class="text-gray-300 mr-4 hidden sm:inline"></span>
                    <button id="logout-btn" class="text-gray-300 hover:text-amber-400 transition">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        <span class="hidden sm:inline">Sair</span>
                    </button>
                </div>
                <button id="login-btn" class="hidden btn-primary text-sm py-2 px-4">Login</button>
            </div>
            <button id="mobile-menu-btn" class="md:hidden text-white text-2xl">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <!-- Menu Mobile -->
        <div id="mobile-menu" class="hidden md:hidden bg-gray-900 bg-opacity-95 p-4 space-y-3 fixed top-16 right-0 left-0 z-30 shadow-lg">
            <button data-view="home-view" class="internal-link nav-link block w-full text-left text-gray-300 hover:text-amber-400 transition title-font py-2">Início</button>
            <button data-view="blog-view" class="internal-link nav-link block w-full text-left text-gray-300 hover:text-amber-400 transition title-font py-2">Blog</button>
            <button data-view="sobre-view" class="internal-link nav-link block w-full text-left text-gray-300 hover:text-amber-400 transition title-font py-2">Sobre Mim</button>
            <a href="https://ardanraven.github.io/Calendario/" target="_blank" rel="noopener noreferrer" class="nav-link block w-full text-left text-gray-300 hover:text-amber-400 transition title-font py-2">Calendário</a>
            <a href="https://caminhodatocha.site" target="_blank" rel="noopener noreferrer" class="nav-link block w-full text-left text-gray-300 hover:text-amber-400 transition title-font py-2">Mentoria</a>
        </div>


        <!-- ===== SEÇÕES PRINCIPAIS (VIEWS) ===== -->
        <main class="p-4 md:p-8">

            <!-- Home View -->
            <div id="home-view" class="view-container">
                <div class="text-center p-8 md:p-16 bg-gray-900 bg-opacity-70 rounded-lg border border-purple-800">
                    <h2 class="text-4xl md:text-6xl font-bold text-white mb-6 title-font text-glow">Bem-vinda às Encruzilhadas</h2>
                    <p class="text-lg md:text-xl text-gray-300 body-font max-w-3xl mx-auto leading-relaxed">
                        Este é o seu santuário digital, um espaço dedicado aos mistérios de Hekate e à jornada da bruxaria. 
                        Explore, aprenda e conecte-se com o poder interior.
                    </p>
                    <button data-view="blog-view" class="internal-link nav-link btn-primary mt-10 title-font text-lg">Explorar o Blog</button>
                </div>
            </div>

            <!-- Blog View (Antiga App View) -->
            <div id="blog-view" class="view-container">
                <!-- Admin Panel -->
                <div id="admin-panel" class="hidden mb-8 p-4 sm:p-6 bg-gray-900 bg-opacity-80 backdrop-blur-sm border border-purple-800 rounded-lg">
                    <h2 class="text-2xl font-bold text-purple-300 border-b border-gray-700 pb-2 mb-4 title-font text-glow">Painel da Guardiã</h2>
                    
                    <!-- Gerenciar Postagens e Contas -->
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Create Post Form -->
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-purple-200 title-font">Criar Nova Postagem</h3>
                            <form id="create-post-form">
                                <div class="mb-4">
                                    <label for="post-title" class="block text-sm font-medium text-gray-300 mb-2">Título</label>
                                    <input type="text" id="post-title" class="w-full p-3 form-input" required>
                                </div>
                                <div class="mb-4">
                                    <label for="post-cover-image" class="block text-sm font-medium text-gray-300 mb-2">Imagem de Capa (Link)</label>
                                    <input type="url" id="post-cover-image" placeholder="https://i.ibb.co/..." class="w-full p-3 form-input" required>
                                </div>
                                <div class="mb-4">
                                    <label for="post-content" class="block text-sm font-medium text-gray-300 mb-2">Conteúdo</label>
                                    <textarea id="post-content" rows="8" class="w-full p-3 form-input" required></textarea>
                                    <p class="text-xs text-gray-400 mt-1">Use `**` para negrito, `*` para destaque, `##` para termo místico, ou `![legenda](link-imagem)` para imagens no texto.</p>
                                </div>
                                <div class="mb-4">
                                    <label for="post-attachment-name" class="block text-sm font-medium text-gray-300 mb-2">Nome do Link (Opcional)</label>
                                    <input type="text" id="post-attachment-name" placeholder="Ex: Material de Apoio" class="w-full p-3 form-input">
                                </div>
                                 <div class="mb-4">
                                    <label for="post-attachment-link" class="block text-sm font-medium text-gray-300 mb-2">Link do Anexo (Opcional)</label>
                                    <input type="url" id="post-attachment-link" placeholder="https://..." class="w-full p-3 form-input">
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label for="post-access" class="block text-sm font-medium text-gray-300 mb-2">Acesso</label>
                                        <select id="post-access" class="w-full p-3 form-input">
                                            <option value="pago">Acesso Pago (Assinantes)</option>
                                            <option value="aberto" selected>Acesso Aberto (Público)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="post-section" class="block text-sm font-medium text-gray-300 mb-2">Seção (Módulo)</label>
                                        <select id="post-section" class="w-full p-3 form-input" required>
                                            <option value="">Carregando seções...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button type="submit" class="btn-primary">Publicar</button>
                                    <button type="button" id="format-create-btn" class="btn-accent"><i class="fas fa-magic mr-2"></i>Formatar com IA</button>
                                </div>
                                <p id="post-status" class="text-green-500 mt-2"></p>
                            </form>
                        </div>
                        <!-- Create User Account Form -->
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-purple-200 title-font">Criar Acesso de Assinante</h3>
                            <form id="create-account-form">
                                <div class="mb-4">
                                    <label for="new-email" class="block text-sm font-medium text-gray-300 mb-2">Email do Assinante</label>
                                    <input type="email" id="new-email" class="w-full p-3 form-input" required>
                                </div>
                                <div class="mb-4">
                                    <label for="new-password" class="block text-sm font-medium text-gray-300 mb-2">Senha Provisória</label>
                                    <input type="password" id="new-password" class="w-full p-3 form-input" required>
                                </div>
                                <div class="mb-6">
                                    <label for="account-validity" class="block text-sm font-medium text-gray-300 mb-2">Validade da Conta</label>
                                    <select id="account-validity" class="w-full p-3 form-input">
                                        <option value="1" selected>1 Mês</option>
                                        <option value="3">3 Meses</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn-primary">Criar Conta</button>
                                 <p id="account-status" class="text-green-500 mt-2"></p>
                            </form>
                        </div>
                    </div>

                    <!-- Gerenciar Seções -->
                    <div class="mt-12 border-t border-gray-700 pt-6">
                        <h3 class="text-xl font-semibold mb-3 text-purple-200 title-font">Gerenciar Seções (Módulos)</h3>
                        <div class="grid md:grid-cols-2 gap-8">
                            <!-- Criar Seção -->
                            <div>
                                <form id="create-section-form">
                                    <label for="section-name" class="block text-sm font-medium text-gray-300 mb-2">Nome da Nova Seção</label>
                                    <input type="text" id="section-name" placeholder="Ex: Módulo 1, Tarot..." class="w-full p-3 form-input" required>
                                    <button type="submit" class="btn-primary mt-3">Criar Seção</button>
                                    <p id="section-status" class="text-green-500 mt-2"></p>
                                </form>
                            </div>
                            <!-- Seções Atuais -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Seções Atuais</label>
                                <div id="sections-list-admin" class="space-y-2 max-h-48 overflow-y-auto bg-gray-800 p-3 rounded-lg border border-gray-700">
                                    <!-- Lista de seções será populada pelo JS -->
                                    <p class="text-gray-400">Carregando seções...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gerenciar Alunos -->
                    <div class="mt-12 border-t border-gray-700 pt-6">
                        <h3 class="text-xl font-semibold mb-3 text-purple-200 title-font">Gerenciar Alunos (Assinantes)</h3>
                        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Alunos Atuais</label>
                            <div id="students-list-admin" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- Lista de alunos será populada pelo JS -->
                                <p class="text-gray-400">Carregando alunos...</p>
                            </div>
                        </div>
                    </div>

                     <!-- API Key (Seção atualizada para esconder se houver chave no código) -->
                    <div id="api-key-section" class="mt-12 p-4 bg-gray-800 border border-gray-700 rounded-md">
                        <label for="gemini-api-key" class="block text-sm font-medium text-gray-300 mb-2">Chave API do Google AI Studio</G>
                        <input type="password" id="gemini-api-key" placeholder="Cole sua chave API aqui para habilitar a formatação com IA" class="w-full p-3 form-input">
                        <p class="text-xs text-gray-400 mt-1">A chave é necessária para formatar textos e gerar áudio das aulas. Ela é salva apenas no seu navegador.</p>
                    </div>
                </div>

                <!-- Filtro de Seção -->
                <div class="mb-8 max-w-sm">
                    <label for="section-filter" class="block text-sm font-medium text-gray-300 mb-2 title-font">Filtrar por Seção:</label>
                    <select id="section-filter" class="w-full p-3 form-input">
                        <option value="todos">Todas as Seções</option>
                        <!-- Opções populadas pelo JS -->
                    </select>
                </div>

                <!-- Posts Sections -->
                <div class="space-y-12">
                    <!-- Seção de Conteúdo Pago -->
                    <div id="pago-section" class="hidden">
                        <h2 class="text-3xl font-bold text-white mb-6 title-font text-glow border-b-2 border-purple-800 pb-2">Conteúdo Pago (Assinantes)</h2>
                        <div id="posts-list-pago" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Paid post cards will be injected here -->
                        </div>
                        <p id="empty-pago" class="text-gray-400 col-span-full text-center hidden">Nenhuma postagem encontrada nesta seção ou você não tem permissão.</p>
                    </div>
                    <!-- Seção de Conteúdo Aberto -->
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-6 title-font text-glow border-b-2 border-purple-800 pb-2">Conteúdo Aberto</h2>
                        <div id="posts-list-aberto" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Public post cards will be injected here -->
                        </div>
                        <p id="empty-aberto" class="text-gray-400 col-span-full text-center hidden">Nenhuma postagem encontrada nesta seção.</p>
                    </div>
                </div>
            </div>

            <!-- Calendar View (Placeholder) -->
            <div id="calendar-view" class="view-container">
                <div class="text-center p-8 md:p-16 bg-gray-900 bg-opacity-70 rounded-lg border border-purple-800">
                    <h2 class="text-4xl md:text-6xl font-bold text-white mb-6 title-font text-glow">Calendário Hekatino</h2>
                    <p class="text-lg md:text-xl text-gray-300 body-font max-w-3xl mx-auto leading-relaxed mb-8">
                        O botão "Calendário" no menu agora leva diretamente para o site externo.
                    </p>
                </div>
            </div>

            <!-- SEÇÃO: Sobre Mim View -->
            <div id="sobre-view" class="view-container">
                 <div class="p-8 md:p-12 bg-gray-900 bg-opacity-70 rounded-lg border border-purple-800 max-w-5xl mx-auto">
                    <h2 class="text-4xl font-bold text-white mb-10 text-center title-font text-glow">Sobre o Sacerdote Leonardo</h2>
                    <div class="flex flex-col md:flex-row gap-8 items-center">
                        <div class="md:w-1/3 w-full flex-shrink-0">
                            <img src="https://i.ibb.co/0ymRCF5C/2-DACB7-CC-CE28-4383-BD50-DEB2-C7-A38721.png" alt="Sacerdote Leonardo" class="rounded-lg shadow-lg border-2 border-purple-700 w-full h-auto object-cover">
                        </div>
                        <div class="md:w-2/3 w-full body-font text-lg text-gray-300 leading-relaxed space-y-5">
                            <p>Saudações! Eu sou Leonardo, Sacerdote de Hekate e o guardião deste espaço.</p>
                            <p>Minha jornada com a Deusa das Encruzilhadas começou há muitos anos, uma caminhada de sombras e luz, mistérios e revelações. Hekate me chamou para ser Sua tocha no mundo, para guiar aqueles que buscam Sua sabedoria e Seu poder.</p>
                            <p>Neste santuário, "O Corvo de Hekate", eu compartilho os ensinamentos, rituais e visões que recebi ao longo da minha devoção. Este não é apenas um blog, mas um ponto de encontro para almas que, como corvos, voam entre os mundos em busca de conhecimento.</p>
                            <p>Sinta-se em casa. Explore, questione e que as chaves de Hekate abram os portais do seu próprio poder.</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- ===== SEÇÕES SECUNDÁRIAS (MODAIS/VIEWS) ===== -->

        <!-- Login View -->
        <div id="login-view" class="view-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
            <div class="w-full max-w-md bg-gray-900 bg-opacity-90 backdrop-blur-sm rounded-lg shadow-lg border border-purple-800 p-6 sm:p-8 relative">
                 <button id="close-login-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h1 class="text-3xl sm:text-4xl font-bold text-center text-purple-300 mb-2 title-font text-glow">Acesso</h1>
                <p class="text-center text-gray-400 mb-8">Faça login para acessar o conteúdo restrito.</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full p-3 form-input" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Senha</label>
                        <input type="password" id="login-password" class="w-full p-3 form-input" required>
                    </div>
                    <button type="submit" class="w-full btn-primary title-font">Entrar</button>
                </form>
                <p id="login-error" class="text-red-500 text-center mt-4"></p>
            </div>
        </div>

        <!-- Single Post View -->
        <div id="post-view" class="view-container min-h-screen bg-black">
             <header class="bg-gray-900 bg-opacity-80 backdrop-blur-sm shadow-md border-b-2 border-purple-800 p-4 flex justify-between items-center sticky top-0 z-10">
                <button id="back-to-posts-btn" class="text-gray-300 hover:text-amber-400 transition title-font">
                    <i class="fas fa-arrow-left mr-2"></i>Voltar para o Blog
                </button>
                <div class="admin-only-controls">
                     <button id="post-view-edit-btn" class="text-gray-300 hover:text-amber-400 transition mr-4"><i class="fas fa-pencil-alt mr-1"></i> Editar</button>
                    <button id="post-view-delete-btn" class="text-gray-300 hover:text-red-500 transition"><i class="fas fa-trash-alt mr-1"></i> Excluir</button>
                </div>
            </header>
            <main class="p-4 md:p-8 lg:p-12 max-w-4xl mx-auto">
                 <h2 id="post-view-title" class="text-3xl sm:text-4xl lg:text-5xl font-bold text-purple-300 mb-6 title-font text-glow"></h2>
                 
                 <!-- Audio Player Button (Gemini AI TTS) -->
                 <div id="audio-controls" class="flex items-center gap-4 mb-6 bg-gray-800 bg-opacity-50 p-3 rounded-lg border border-purple-800 w-fit transition-all duration-300">
                    <button id="btn-speak" class="text-amber-400 hover:text-amber-300 transition flex items-center">
                        <i id="btn-speak-icon" class="fas fa-volume-up text-xl"></i> 
                        <span id="btn-speak-text" class="ml-2 font-bold title-font text-sm uppercase tracking-wide">Ouvir o Chamado</span>
                    </button>
                    <button id="btn-stop-speak" class="text-gray-400 hover:text-red-400 transition hidden" title="Parar Leitura">
                        <i class="fas fa-stop"></i>
                    </button>
                    <!-- Elemento de áudio invisível para tocar o WAV gerado -->
                    <audio id="gemini-audio-player" class="hidden"></audio>
                </div>

                 <!-- View count display -->
                 <div id="post-view-meta" class="text-gray-400 mb-6 text-lg title-font">
                     <i class="fas fa-eye mr-1"></i> <span id="post-view-count">0</span> visualizações
                 </div>
                 <img id="post-view-cover-image" src="" alt="Imagem de Capa" class="w-full h-64 md:h-96 object-cover rounded-lg mb-8 border border-purple-800 shadow-lg">
                 <div id="post-view-content" class="text-gray-300 body-font leading-relaxed whitespace-pre-wrap text-lg"></div>
                 <div id="post-view-attachment-container" class="hidden mt-10">
                     <h3 class="font-semibold text-xl text-purple-200 mb-3 border-t border-gray-700 pt-6 title-font">Anexo:</h3>
                     <a id="post-view-attachment" href="#" target="_blank" class="text-amber-400 hover:underline text-lg"></a>
                 </div>
            </main>
        </div>
        
        <!-- Edit Post View -->
        <div id="edit-post-view" class="view-container min-h-screen bg-black">
             <header class="bg-gray-900 bg-opacity-80 backdrop-blur-sm shadow-md border-b-2 border-purple-800 p-4 flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-2xl font-bold text-purple-300 title-font text-glow">Editando Postagem</h2>
             </header>
             <main class="p-4 md:p-8 max-w-3xl mx-auto">
                 <form id="edit-post-form">
                    <input type="hidden" id="edit-post-id">
                    <div class="mb-4">
                        <label for="edit-post-title" class="block text-sm font-medium text-gray-300 mb-2">Título</label>
                        <input type="text" id="edit-post-title" class="w-full p-3 form-input" required>
                    </div>
                     <div class="mb-4">
                        <label for="edit-post-cover-image" class="block text-sm font-medium text-gray-300 mb-2">Imagem de Capa (Link)</label>
                        <input type="url" id="edit-post-cover-image" placeholder="https://i.ibb.co/..." class="w-full p-3 form-input" required>
                    </div>
                    <div class="mb-4">
                        <label for="edit-post-content" class="block text-sm font-medium text-gray-300 mb-2">Conteúdo</label>
                        <textarea id="edit-post-content" rows="12" class="w-full p-3 form-input" required></textarea>
                         <p class="text-xs text-gray-400 mt-1">Use `**` para negrito, `*` para destaque, `##` para termo místico, ou `![legenda](link-imagem)` para imagens no texto.</p>
                    </div>
                    <div class="mb-4">
                        <label for="edit-post-attachment-name" class="block text-sm font-medium text-gray-300 mb-2">Nome do Link (Opcional)</label>
                        <input type="text" id="edit-post-attachment-name" class="w-full p-3 form-input">
                    </div>
                     <div class="mb-6">
                        <label for="edit-post-attachment-link" class="block text-sm font-medium text-gray-300 mb-2">Link do Anexo (Opcional)</label>
                        <input type="url" id="edit-post-attachment-link" class="w-full p-3 form-input">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="edit-post-access" class="block text-sm font-medium text-gray-300 mb-2">Acesso</label>
                            <select id="edit-post-access" class="w-full p-3 form-input">
                                <option value="pago">Acesso Pago (Assinantes)</option>
                                <option value="aberto">Acesso Aberto (Público)</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-post-section" class="block text-sm font-medium text-gray-300 mb-2">Seção (Módulo)</label>
                            <select id="edit-post-section" class="w-full p-3 form-input" required>
                                <option value="">Carregando seções...</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button type="submit" class="btn-primary">Salvar Alterações</button>
                        <button type="button" id="format-edit-btn" class="btn-accent"><i class="fas fa-magic mr-2"></i>Formatar com IA</button>
                        <button type="button" id="cancel-edit-btn" class="bg-gray-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-gray-500 transition">Cancelar</button>
                    </div>
                    <p id="edit-post-status" class="mt-4"></p>
                </form>
             </main>
        </div>
    </div>
    
    <!-- Modal de Gerenciar Aluno -->
    <div id="manage-student-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 bg-opacity-95 backdrop-blur-sm border border-purple-800 rounded-lg max-w-lg w-full p-8 relative">
            <button id="close-student-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-white mb-2 title-font">Gerenciar Acessos</h2>
            <p class="text-purple-300 mb-6 text-lg">Aluno: <span id="student-modal-email"></span></p>
            
            <input type="hidden" id="student-modal-id">
            
            <label class="block text-sm font-medium text-gray-300 mb-2">Liberar acesso às seções (módulos):</label>
            <div id="student-modal-sections-list" class="max-h-64 overflow-y-auto bg-gray-800 p-4 rounded-lg border border-gray-700 mb-6">
                <!-- Checkboxes das seções serão populadas pelo JS -->
                <p class="text-gray-400">Carregando seções...</p>
            </div>
            
            <div class="flex justify-end gap-4">
                <button id="cancel-student-modal-btn" class="btn-secondary">Cancelar</button>
                <button id="save-student-sections-btn" class="btn-primary">Salvar Permissões</button>
            </div>
            <p id="student-modal-status" class="text-green-500 mt-4 text-center"></p>
        </div>
    </div>
    
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 bg-opacity-95 backdrop-blur-sm border border-purple-800 rounded-lg max-w-sm w-full p-8 text-center">
            <h2 id="delete-modal-title" class="text-xl font-bold text-white mb-4 title-font">Confirmar Exclusão</h2>
            <p id="delete-modal-text" class="text-gray-400 mb-8">Você tem certeza que deseja excluir? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-red-500 transition">Excluir</button>
                <button id="cancel-delete-btn" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-gray-500 transition">Cancelar</button>
            </div>
        </div>
    </div>


    <!-- MUDANÇA: Script do player do Vimeo adicionado -->
    <script src="https://player.vimeo.com/api/player.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, query, deleteDoc, updateDoc, setLogLevel, orderBy, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------------------------------------------------
        // ✨ LOCAL PARA A CHAVE API (HARDCODED) ✨
        // ------------------------------------------------------------
        // Se você quiser pular a etapa de colar a chave no site toda vez,
        // cole sua chave API do Google AI Studio dentro das aspas abaixo.
        // Exemplo: const HARDCODED_API_KEY = "AIzaSyB...";
        // ------------------------------------------------------------
        const HARDCODED_API_KEY = "AIzaSyA2m-CD-RJOiac90q7p4iql7fYyhlnW1xY"; 
        // ------------------------------------------------------------

        // SUA NOVA CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyBQXn_dPUivGjfGrWvMwysa-IDX8eXNbCA",
          authDomain: "corvo-4f7e7.firebaseapp.com",
          projectId: "corvo-4f7e7",
          storageBucket: "corvo-4f7e7.firebasestorage.app",
          messagingSenderId: "793120208869",
          appId: "1:793120208869:web:378c37a33c729ff1a6e10c",
          measurementId: "G-V8LBRHPNKT"
        };
        
        // =========================================================================
        // === IMPORTANTE! AÇÃO NECESSÁRIA! ========================================
        // =========================================================================
        // 1. Vá para o seu console do Firebase -> Authentication.
        // 2. Crie um usuário (ex: admin@corvo.hekate) com uma senha forte.
        // 3. Após criar, clique nele para ver o "UID do usuário".
        // 4. COLE ESSE UID AQUI ABAIXO:
        //
        const ADMIN_UID = "9yeLL3aKVXVHKiBNKI3yFiCPMIE3"; // <-- TROQUE ISSO
        //
        // =========================================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); // Para vermos logs detalhados no console

        // State variables
        let currentUser = null;
        let currentUserPermissions = []; // Guarda as permissões do aluno logado
        let itemToDelete = { id: null, type: null }; // { id: 'xyz', type: 'post' | 'section' }
        let allPosts = [];
        let allSections = [];
        let allStudents = []; // Guarda a lista de alunos para o admin

        // DOM Elements
        const introSection = document.getElementById('intro-sequence');
        const appRoot = document.getElementById('app-root');
        const allViews = document.querySelectorAll('.view-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userInfo = document.getElementById('user-info');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const loginBtn = document.getElementById('login-btn');
        const adminPanel = document.getElementById('admin-panel');
        const pagoSection = document.getElementById('pago-section');
        const geminiApiKeyInput = document.getElementById('gemini-api-key');
        const apiKeySection = document.getElementById('api-key-section'); // Nova referência
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        
        // Forms
        const loginForm = document.getElementById('login-form');
        const createPostForm = document.getElementById('create-post-form');
        const createAccountForm = document.getElementById('create-account-form');
        const editPostForm = document.getElementById('edit-post-form');
        const createSectionForm = document.getElementById('create-section-form');

        // Lists & Statuses
        const postsListPago = document.getElementById('posts-list-pago');
        const postsListAberto = document.getElementById('posts-list-aberto');
        const emptyPago = document.getElementById('empty-pago');
        const emptyAberto = document.getElementById('empty-aberto');
        const loginError = document.getElementById('login-error');
        const postStatus = document.getElementById('post-status');
        const accountStatus = document.getElementById('account-status');
        const editPostStatus = document.getElementById('edit-post-status');
        const sectionStatus = document.getElementById('section-status');
        const sectionsListAdmin = document.getElementById('sections-list-admin');
        const studentsListAdmin = document.getElementById('students-list-admin'); 

        // Selects & Filters
        const sectionFilter = document.getElementById('section-filter');
        const postSectionSelect = document.getElementById('post-section');
        const editPostSectionSelect = document.getElementById('edit-post-section');

        // Buttons
        const backToPostsBtn = document.getElementById('back-to-posts-btn');
        const closeLoginBtn = document.getElementById('close-login-btn');
        const postViewEditBtn = document.getElementById('post-view-edit-btn');
        const postViewDeleteBtn = document.getElementById('post-view-delete-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const formatCreateBtn = document.getElementById('format-create-btn');
        const formatEditBtn = document.getElementById('format-edit-btn');
        
        // Single Post View Elements
        const postViewTitle = document.getElementById('post-view-title');
        const postViewCoverImage = document.getElementById('post-view-cover-image');
        const postViewContent = document.getElementById('post-view-content');
        const postViewAttachmentContainer = document.getElementById('post-view-attachment-container');
        const postViewAttachment = document.getElementById('post-view-attachment');
        const postViewCountSpan = document.getElementById('post-view-count');

        // TTS Elements
        const btnSpeak = document.getElementById('btn-speak');
        const btnSpeakText = document.getElementById('btn-speak-text');
        const btnSpeakIcon = document.getElementById('btn-speak-icon');
        const btnStopSpeak = document.getElementById('btn-stop-speak');
        const audioContainer = document.getElementById('audio-controls');
        const geminiAudioPlayer = document.getElementById('gemini-audio-player');


        // Modals
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalText = document.getElementById('delete-modal-text');
        
        // Elementos do Modal de Aluno
        const manageStudentModal = document.getElementById('manage-student-modal');
        const closeStudentModalBtn = document.getElementById('close-student-modal-btn');
        const cancelStudentModalBtn = document.getElementById('cancel-student-modal-btn');
        const saveStudentSectionsBtn = document.getElementById('save-student-sections-btn');
        const studentModalEmail = document.getElementById('student-modal-email');
        const studentModalIdInput = document.getElementById('student-modal-id');
        const studentModalSectionsList = document.getElementById('student-modal-sections-list');
        const studentModalStatus = document.getElementById('student-modal-status');
        

        // --- MUDANÇA: INTRO ANIMATION ---
        function runIntroAnimation() {
            const introSection = document.getElementById('intro-sequence');
            const appRoot = document.getElementById('app-root');
            
            // A duração do seu vídeo em milissegundos
            const VIDEO_DURATION_MS = 10000; 

            const onIntroComplete = () => {
                gsap.to(introSection, 0.8, { 
                    opacity: 0,
                    ease: 'power2.inOut',
                    onComplete: () => {
                        introSection.style.display = 'none';
                        appRoot.style.display = 'block';
                        document.body.style.overflow = 'auto';
                    }
                });
            };

            setTimeout(onIntroComplete, VIDEO_DURATION_MS);
        }

        // --- CORE APP LOGIC ---
        
        window.onload = () => {
            runIntroAnimation(); // Inicia a nova intro de vídeo
            showView('home-view'); // Começa na Home
            
            // Verifica se a chave foi hardcoded
            if (HARDCODED_API_KEY && HARDCODED_API_KEY.length > 10) {
                console.log("Chave API Hardcoded detectada.");
                if(apiKeySection) apiKeySection.style.display = 'none'; // Esconde o input
            }
        };

        if (localStorage.getItem('geminiApiKey') && !HARDCODED_API_KEY) {
            geminiApiKeyInput.value = localStorage.getItem('geminiApiKey');
        }
        geminiApiKeyInput.addEventListener('input', () => {
            localStorage.setItem('geminiApiKey', geminiApiKeyInput.value);
        });

        // --- NAVIGATION ---
        function showView(viewId) {
            allViews.forEach(view => {
                // Mantém os modais como overlays (login e os novos)
                if (view.classList.contains('fixed')) {
                    if (view.id === viewId) {
                        view.style.display = 'flex';
                    } else if (view.id !== 'manage-student-modal' && view.id !== 'delete-confirm-modal') {
                         // Não esconde os modais de gerenciamento se estiver trocando de view principal
                        view.style.display = 'none';
                    }
                } 
                // Esconde/mostra outras views principais
                else {
                    view.style.display = view.id === viewId ? 'block' : 'none';
                }
            });
            if (viewId !== 'login-view' && viewId !== 'manage-student-modal' && viewId !== 'delete-confirm-modal') {
                window.scrollTo(0, 0);
            }
            mobileMenu.classList.add('hidden'); // Esconde menu mobile ao trocar de view
        }

        // Apenas botões com a classe 'internal-link' trocam de view
        document.querySelectorAll('.internal-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const viewId = e.currentTarget.dataset.view;
                if (viewId) {
                    showView(viewId);
                    // IMPORTANTE: Parar o áudio ao trocar de tela
                    stopSpeaking();
                }
            });
        });

        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        onAuthStateChanged(auth, async (user) => {
            currentUserPermissions = []; // Reseta permissões a cada mudança
            if (user) { // USER IS LOGGED IN
                console.log("Usuário logado:", user.uid);
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                const isAdmin = user.uid === ADMIN_UID;

                // Verifica validade da conta (exceto para admin)
                if (!isAdmin && userDocSnap.exists()) {
                    const expiresAt = userDocSnap.data().expiresAt.toDate();
                    if (new Date() > expiresAt) {
                        console.log("Conta expirada. Fazendo logout.");
                        await signOut(auth); // Isso irá re-trigger onAuthStateChanged
                        return;
                    }
                    // Carrega as permissões do aluno
                    currentUserPermissions = userDocSnap.data().accessibleSections || [];
                    console.log("Permissões do aluno carregadas:", currentUserPermissions);

                } else if (!isAdmin && !userDocSnap.exists()) {
                    // Se não tem documento E não é admin, é um usuário inválido.
                    console.log("Usuário sem registro. Fazendo logout.");
                    await signOut(auth); // Isso irá re-trigger onAuthStateChanged
                    return;
                }
                
                currentUser = user;
                // Configure UI for LOGGED-IN user
                userEmailSpan.textContent = user.email;
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                pagoSection.style.display = 'block'; // Mostra seção paga
                
                console.log("É admin?", isAdmin);
                adminPanel.style.display = isAdmin ? 'block' : 'none';
                document.querySelectorAll('.admin-only-controls').forEach(el => el.style.display = isAdmin ? 'flex' : 'none');
                
                // Se for admin, carrega a lista de alunos
                if (isAdmin) {
                    fetchAndRenderStudents();
                }

                // Se estava na tela de login, manda para o blog
                if (document.getElementById('login-view').style.display === 'flex') {
                    showView('blog-view');
                }

            } else { // USER IS LOGGED OUT (GUEST)
                console.log("Usuário deslogado.");
                currentUser = null;
                // Configure UI for GUEST user
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
                adminPanel.style.display = 'none';
                pagoSection.style.display = 'none'; // Esconde seção paga
                document.querySelectorAll('.admin-only-controls').forEach(el => el.style.display = 'none');
            }
            fetchPosts(); // Fetch posts (abertos) para todos
            fetchAndRenderSections(); // Puxa as seções
            loadingSpinner.style.display = 'none';
        });

        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            loginError.textContent = "";
            loadingSpinner.style.display = 'flex';
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    console.error("Erro de login:", error.code);
                    loginError.textContent = "Email ou senha inválidos.";
                    loadingSpinner.style.display = 'none';
                });
        });
        logoutBtn.addEventListener('click', () => signOut(auth));
        loginBtn.addEventListener('click', () => showView('login-view'));
        closeLoginBtn.addEventListener('click', () => {
            // Volta para a view que estava aberta antes, ou home
            const currentView = [...allViews].find(v => v.style.display === 'block' && v.id !== 'login-view');
            showView(currentView ? currentView.id : 'home-view');
        });

        // --- ADMIN: ACCOUNT CREATION ---
        createAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = createAccountForm['new-email'].value;
            const password = createAccountForm['new-password'].value;
            const validityMonths = parseInt(createAccountForm['account-validity'].value);
            accountStatus.textContent = "Criando conta...";
            accountStatus.className = 'text-yellow-500 mt-2';
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const now = new Date();
                const expiresAt = new Date(now.setMonth(now.getMonth() + validityMonths));
                
                // Adiciona a lista de seções acessíveis (vazia)
                await setDoc(doc(db, "users", user.uid), {
                    email: user.email,
                    createdAt: new Date(),
                    expiresAt: expiresAt,
                    accessibleSections: [] // Começa sem acesso a nenhum módulo
                });
                accountStatus.textContent = `Conta criada para ${email} com sucesso!`;
                accountStatus.className = 'text-green-500 mt-2';
                createAccountForm.reset();
                console.warn("Conta de usuário criada. A sessão do admin pode ter sido deslogada. Re-login pode ser necessário.");
            } catch (error) {
                console.error("Erro ao criar conta:", error.code);
                if (error.code === 'auth/email-already-in-use') {
                    accountStatus.textContent = "Este email já está em uso.";
                } else if (error.code === 'auth/weak-password') {
                    accountStatus.textContent = "A senha deve ter pelo menos 6 caracteres.";
                } else {
                    accountStatus.textContent = "Erro ao criar conta.";
                }
                accountStatus.className = 'text-red-500 mt-2';
            }
        });
        
        // --- STUDENT MANAGEMENT (Admin) ---
        function fetchAndRenderStudents() {
            const q = query(collection(db, "users"));
            onSnapshot(q, (snapshot) => {
                allStudents = [];
                studentsListAdmin.innerHTML = '';
                
                let studentCount = 0;
                snapshot.forEach(doc => {
                    // Pula a conta do Admin
                    if (doc.id === ADMIN_UID) return; 
                    
                    const student = { id: doc.id, ...doc.data() };
                    allStudents.push(student);
                    studentCount++;

                    // Formata a data de expiração
                    const expiresDate = student.expiresAt.toDate();
                    const isExpired = new Date() > expiresDate;
                    const dateString = expiresDate.toLocaleDateString('pt-BR');

                    const studentItem = document.createElement('div');
                    studentItem.className = `flex justify-between items-center bg-gray-700 p-3 rounded ${isExpired ? 'opacity-50' : ''}`;
                    studentItem.innerHTML = `
                        <div>
                            <span class="text-gray-200">${student.email}</span>
                            <span class="block text-xs ${isExpired ? 'text-red-400' : 'text-gray-400'}">
                                ${isExpired ? 'Expirado em' : 'Expira em'}: ${dateString}
                            </span>
                        </div>
                        <button class="manage-student-btn btn-accent text-sm py-1 px-3" data-id_student="${student.id}">
                            <i class="fas fa-tasks mr-1"></i> Gerenciar
                        </button>
                    `;
                    studentsListAdmin.appendChild(studentItem);
                });
                
                if (studentCount === 0) {
                     studentsListAdmin.innerHTML = '<p class="text-gray-400">Nenhum aluno assinante encontrado.</p>';
                }
            });
        }
        
        function openStudentModal(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                console.error("Aluno não encontrado:", studentId);
                return;
            }
            
            studentModalEmail.textContent = student.email;
            studentModalIdInput.value = student.id;
            studentModalSectionsList.innerHTML = '';
            studentModalStatus.textContent = '';
            
            if (allSections.length === 0) {
                studentModalSectionsList.innerHTML = '<p class="text-gray-400">Nenhuma seção (módulo) foi criada ainda.</p>';
                return;
            }

            // Popula a lista de seções (módulos) com checkboxes
            allSections.forEach(section => {
                const isChecked = student.accessibleSections && student.accessibleSections.includes(section.id);
                const label = document.createElement('label');
                label.className = 'student-section-label';
                label.innerHTML = `
                    <input type="checkbox" value="${section.id}" ${isChecked ? 'checked' : ''} class="w-4 h-4">
                    ${section.name}
                `;
                studentModalSectionsList.appendChild(label);
            });
            
            manageStudentModal.style.display = 'flex';
        }
        
        async function saveStudentSections() {
            const studentId = studentModalIdInput.value;
            saveStudentSectionsBtn.disabled = true;
            saveStudentSectionsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
            studentModalStatus.textContent = '';
            
            const checkedBoxes = studentModalSectionsList.querySelectorAll('input[type="checkbox"]:checked');
            const newSections = Array.from(checkedBoxes).map(cb => cb.value);
            
            try {
                const studentRef = doc(db, "users", studentId);
                await updateDoc(studentRef, {
                    accessibleSections: newSections
                });
                
                // Atualiza a lista local 'allStudents' para refletir a mudança
                const studentIndex = allStudents.findIndex(s => s.id === studentId);
                if (studentIndex > -1) {
                    allStudents[studentIndex].accessibleSections = newSections;
                }
                
                studentModalStatus.className = 'text-green-500 mt-4 text-center';
                studentModalStatus.textContent = 'Permissões atualizadas com sucesso!';
                
                setTimeout(() => {
                    manageStudentModal.style.display = 'none';
                    studentModalStatus.textContent = '';
                }, 1500);

            } catch (error) {
                console.error("Erro ao salvar permissões:", error);
                studentModalStatus.className = 'text-red-500 mt-4 text-center';
                studentModalStatus.textContent = 'Erro ao salvar permissões.';
            } finally {
                saveStudentSectionsBtn.disabled = false;
                saveStudentSectionsBtn.innerHTML = 'Salvar Permissões';
            }
        }
        
        // Listeners do Modal de Aluno
        saveStudentSectionsBtn.addEventListener('click', saveStudentSections);
        closeStudentModalBtn.addEventListener('click', () => manageStudentModal.style.display = 'none');
        cancelStudentModalBtn.addEventListener('click', () => manageStudentModal.style.display = 'none');


        // --- SECTION MANAGEMENT (CRUD) ---
        function fetchAndRenderSections() {
            const q = query(collection(db, "sections"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                allSections = [];
                // Limpa todos os dropdowns e a lista do admin
                sectionFilter.innerHTML = '<option value="todos">Todas as Seções</option>';
                postSectionSelect.innerHTML = '<option value="">Selecione uma Seção</option>';
                editPostSectionSelect.innerHTML = '<option value="">Selecione uma Seção</option>';
                sectionsListAdmin.innerHTML = '';

                snapshot.forEach(doc => {
                    const section = { id: doc.id, ...doc.data() };
                    allSections.push(section);

                    // 1. Popula o filtro principal
                    const filterOption = new Option(section.name, section.id);
                    sectionFilter.add(filterOption);

                    // 2. Popula o select de criar post
                    const createOption = new Option(section.name, section.id);
                    postSectionSelect.add(createOption);

                    // 3. Popula o select de editar post
                    const editOption = new Option(section.name, section.id);
                    editPostSectionSelect.add(editOption);

                    // 4. Popula a lista no admin panel
                    const sectionItem = document.createElement('div');
                    sectionItem.className = "flex justify-between items-center bg-gray-700 p-2 rounded";
                    sectionItem.innerHTML = `
                        <span class="text-gray-200">${section.name}</span>
                        <button class="delete-section-btn text-gray-400 hover:text-red-500" data-id_sec="${section.id}" data-name_sec="${section.name}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    sectionsListAdmin.appendChild(sectionItem);
                });
                if (allSections.length === 0) {
                     sectionsListAdmin.innerHTML = '<p class="text-gray-400">Nenhuma seção criada.</p>';
                }
            });
        }

        createSectionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sectionName = createSectionForm['section-name'].value;
            if (!sectionName.trim()) return;

            sectionStatus.textContent = "Criando...";
            sectionStatus.className = 'text-yellow-500 mt-2';
            try {
                await addDoc(collection(db, "sections"), {
                    name: sectionName,
                    createdAt: new Date()
                });
                sectionStatus.textContent = "Seção criada com sucesso!";
                sectionStatus.className = 'text-green-500 mt-2';
                createSectionForm.reset();
            } catch (error) {
                console.error("Erro ao criar seção:", error);
                sectionStatus.textContent = "Erro ao criar seção.";
                sectionStatus.className = 'text-red-500 mt-2';
            }
        });

        sectionsListAdmin.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-section-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id_sec;
                const name = deleteBtn.dataset.name_sec;
                // ABRIR O MODAL DE CONFIRMAÇÃO
                itemToDelete = { id: id, type: 'section' };
                deleteModalTitle.textContent = "Excluir Seção";
                deleteModalText.textContent = `Você tem certeza que deseja excluir a seção "${name}"? Isso NÃO exclui os posts dentro dela, mas eles ficarão sem seção.`;
                deleteConfirmModal.style.display = 'flex';
            }
        });


        // --- POST MANAGEMENT (CRUD) ---
        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            postStatus.textContent = "Publicando...";
            postStatus.className = 'text-yellow-500 mt-2';

            const selectedIndex = createPostForm['post-section'].selectedIndex;
            const sectionName = createPostForm['post-section'].options[selectedIndex].text;

            try {
                await addDoc(collection(db, "posts"), {
                    title: createPostForm['post-title'].value,
                    coverImage: createPostForm['post-cover-image'].value,
                    content: createPostForm['post-content'].value,
                    attachmentURL: createPostForm['post-attachment-link'].value || null,
                    attachmentName: createPostForm['post-attachment-name'].value || null,
                    access: createPostForm['post-access'].value, 
                    sectionId: createPostForm['post-section'].value,
                    sectionName: sectionName,
                    createdAt: new Date(),
                    viewCount: 0 // Inicializa o contador de views
                });
                postStatus.textContent = "Publicado com sucesso!";
                postStatus.className = 'text-green-500 mt-2';
                createPostForm.reset();
                postSectionSelect.selectedIndex = 0; // Reseta o dropdown de seção
            } catch (error) {
                postStatus.textContent = "Erro ao publicar.";
                postStatus.className = 'text-red-500 mt-2';
                console.error("Erro ao criar post:", error);
            }
        });

        function fetchPosts() {
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                allPosts = [];
                snapshot.forEach(doc => {
                    allPosts.push({ id: doc.id, ...doc.data() });
                });
                // Re-renderiza os posts com o filtro atual
                renderPosts(sectionFilter.value);
            });
        }
        
        // ATUALIZADO com lógica de permissão
        function renderPosts(filterSectionId) {
            postsListPago.innerHTML = '';
            postsListAberto.innerHTML = '';
            
            let pagoCount = 0;
            let abertoCount = 0;

            const filteredPosts = (filterSectionId === 'todos')
                ? allPosts
                : allPosts.filter(post => post.sectionId === filterSectionId);

            filteredPosts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = "bg-gray-900 bg-opacity-80 backdrop-blur-sm overflow-hidden rounded-lg border border-gray-700 hover:border-purple-600 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg hover:shadow-purple-500/10 cursor-pointer relative flex flex-col";
                postCard.dataset.id = post.id;
                
                let adminControlsHTML = '';
                if (currentUser && currentUser.uid === ADMIN_UID) {
                    adminControlsHTML = `
                        <div class="absolute top-2 right-2 flex gap-2 z-10">
                            <button class="edit-btn bg-black bg-opacity-50 p-2 rounded-full text-gray-300 hover:text-amber-400" data-id="${post.id}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-btn bg-black bg-opacity-50 p-2 rounded-full text-gray-300 hover:text-red-500" data-id="${post.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                }

                const sectionTagHTML = post.sectionName 
                    ? `<span class="absolute top-2 left-2 bg-purple-800 text-white text-xs font-semibold px-2 py-1 rounded-full z-10">${post.sectionName}</span>` 
                    : '';

                const previewText = stripMarkdown(post.content).substring(0, 100);

                postCard.innerHTML = `
                    ${adminControlsHTML}
                    ${sectionTagHTML}
                    <div class="post-card-content flex-grow flex flex-col">
                        <img src="${post.coverImage}" alt="${post.title}" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/600x400/0a0a0a/4a148c?text=Corvo&font=cinzel'; this.onerror=null;">
                        <div class="p-4 flex-grow flex flex-col">
                            <h3 class="text-xl font-bold text-purple-300 mb-2 title-font text-glow flex-grow">${post.title}</h3>
                            <p class="text-gray-400 mb-4 h-12 overflow-hidden text-ellipsis">${previewText}...</p>
                            <!-- View count no card -->
                            <span class="text-gray-400 text-sm title-font mt-auto pt-2 border-t border-gray-600">
                                <i class="fas fa-eye mr-1"></i> ${post.viewCount || 0} visualizações
                            </span>
                            <div class="text-center mt-2 bg-gray-800 text-amber-400 font-semibold py-2 px-4 rounded title-font">
                                Ler Postagem
                            </div>
                        </div>
                    </div>
                `;
                
                if (post.access === 'aberto') {
                    postsListAberto.appendChild(postCard);
                    abertoCount++;
                } else if (post.access === 'pago') { 
                    // Lógica de Permissão
                    let canViewPaidPost = false;
                    if (currentUser && currentUser.uid === ADMIN_UID) {
                        canViewPaidPost = true; // Admin vê tudo
                    } else if (currentUser && currentUserPermissions.includes(post.sectionId)) {
                        canViewPaidPost = true; // Aluno tem permissão para esta seção
                    }
                    
                    if (canViewPaidPost) {
                        postsListPago.appendChild(postCard);
                        pagoCount++;
                    }
                }
            });
            
            emptyAberto.style.display = (abertoCount === 0) ? 'block' : 'none';
            // Mensagem de "vazio" para pagos considera se o usuário está logado
            const emptyPagoText = (currentUser) 
                ? "Nenhuma postagem encontrada para suas permissões."
                : "Faça login para ver o conteúdo de assinante.";
            emptyPago.textContent = emptyPagoText;
            emptyPago.style.display = (pagoCount === 0 && pagoSection.style.display === 'block') ? 'block' : 'none';
        }
        
        sectionFilter.addEventListener('change', (e) => {
            renderPosts(e.target.value);
        });

        // ATUALIZADO com checagem de permissão E contador de views
        async function openPost(postId) {
            loadingSpinner.style.display = 'flex';
            const docRef = doc(db, "posts", postId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const post = docSnap.data();

                // Checagem de Segurança
                if (post.access === 'pago') {
                    let canView = false;
                    if (currentUser && currentUser.uid === ADMIN_UID) {
                        canView = true; // Admin pode ver
                    } else if (currentUser && currentUserPermissions.includes(post.sectionId)) {
                        canView = true; // Aluno tem permissão
                    }

                    if (!canView) {
                        loadingSpinner.style.display = 'none';
                        if (!currentUser) {
                            // Se deslogado, manda pro login
                            showView('login-view');
                            loginError.textContent = "Você precisa fazer login para acessar este conteúdo.";
                        } else {
                            // Se logado mas sem permissão, só manda de volta pro blog
                            showView('blog-view');
                        }
                        return; // Bloqueia a abertura do post
                    }
                }

                // Incrementa o contador de visualizações
                // "Fire and forget" - não precisamos esperar (await) isso
                const postRef = doc(db, "posts", postId);
                updateDoc(postRef, {
                    viewCount: increment(1)
                }).catch(err => {
                    console.warn("Não foi possível atualizar o view count:", err.message);
                });


                // Se passou na checagem, abre o post
                postViewTitle.textContent = post.title;
                // Popula o contador de views na página do post
                // Mostra o valor + 1 (contando a view atual)
                postViewCountSpan.textContent = (post.viewCount || 0) + 1; 
                postViewCoverImage.src = post.coverImage;
                postViewCoverImage.onerror = () => {
                    postViewCoverImage.src = 'httpsS://placehold.co/600x400/0a0a0a/4a148c?text=Corvo&font=cinzel';
                    postViewCoverImage.onerror = null;
                };
                postViewContent.innerHTML = formatPostText(post.content);
                if (post.attachmentURL && post.attachmentName) {
                    postViewAttachment.href = post.attachmentURL;
                    postViewAttachment.textContent = post.attachmentName;
                    postViewAttachmentContainer.style.display = 'block';
                } else {
                    postViewAttachmentContainer.style.display = 'none';
                }
                
                // Reinicia UI de Audio
                stopSpeaking(); // Garante que não tem nada tocando do anterior
                btnSpeakText.textContent = "Ouvir o Chamado";
                btnStopSpeak.classList.add('hidden');

                postViewEditBtn.dataset.id = postId;
                postViewDeleteBtn.dataset.id = postId;
                loadingSpinner.style.display = 'none';
                showView('post-view');
            } else {
                loadingSpinner.style.display = 'none';
            }
        }
        
        async function openEditForm(postId) {
             const docRef = doc(db, "posts", postId);
             const docSnap = await getDoc(docRef);
             if(docSnap.exists()){
                const post = docSnap.data();
                editPostForm['edit-post-id'].value = postId;
                editPostForm['edit-post-title'].value = post.title;
                editPostForm['edit-post-cover-image'].value = post.coverImage;
                editPostForm['edit-post-content'].value = post.content;
                editPostForm['edit-post-attachment-name'].value = post.attachmentName || '';
                editPostForm['edit-post-attachment-link'].value = post.attachmentURL || '';
                editPostForm['edit-post-access'].value = post.access || 'aberto';
                editPostForm['edit-post-section'].value = post.sectionId || '';
                showView('edit-post-view');
             }
        }
        
        editPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = editPostForm['edit-post-id'].value;
            editPostStatus.textContent = 'Salvando...';
            editPostStatus.className = 'text-yellow-500 mt-4';
            
            const selectedIndex = editPostForm['edit-post-section'].selectedIndex;
            const sectionName = editPostForm['edit-post-section'].options[selectedIndex].text;

            try {
                const postRef = doc(db, "posts", postId);
                await updateDoc(postRef, {
                    title: editPostForm['edit-post-title'].value,
                    coverImage: editPostForm['edit-post-cover-image'].value,
                    content: editPostForm['edit-post-content'].value,
                    attachmentName: editPostForm['edit-post-attachment-name'].value || null,
                    attachmentURL: editPostForm['edit-post-attachment-link'].value || null,
                    access: editPostForm['edit-post-access'].value, 
                    sectionId: editPostForm['edit-post-section'].value, 
                    sectionName: sectionName
                });
                editPostStatus.textContent = 'Salvo com sucesso!';
                editPostStatus.className = 'text-green-500 mt-4';
                setTimeout(() => openPost(postId), 1000);
            } catch (error) {
                 editPostStatus.textContent = 'Erro ao salvar.';
                 editPostStatus.className = 'text-red-500 mt-4';
                 console.error("Erro ao editar post:", error);
            }
        });
        
        function handleDeleteClick(postId) {
            itemToDelete = { id: postId, type: 'post' };
            deleteModalTitle.textContent = "Excluir Postagem";
            deleteModalText.textContent = "Você tem certeza que deseja excluir esta postagem? Esta ação não pode ser desfeita.";
            deleteConfirmModal.style.display = 'flex';
        }
        
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!itemToDelete.id || !itemToDelete.type) return;

            loadingSpinner.style.display = 'flex';
            try {
                if (itemToDelete.type === 'post') {
                    await deleteDoc(doc(db, "posts", itemToDelete.id));
                    if(document.getElementById('post-view').style.display === 'block'){
                        showView('blog-view');
                    }
                } else if (itemToDelete.type === 'section') {
                    await deleteDoc(doc(db, "sections", itemToDelete.id));
                }
            } catch (error) {
                console.error("Erro ao excluir:", error);
            } finally {
                itemToDelete = { id: null, type: null };
                deleteConfirmModal.style.display = 'none';
                loadingSpinner.style.display = 'none';
            }
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            itemToDelete = { id: null, type: null };
            deleteConfirmModal.style.display = 'none';
        });

        // --- EVENT LISTENERS & NAVIGATION ---
        document.getElementById('app-root').addEventListener('click', (e) => {
            const postCard = e.target.closest('[data-id]');
            // Abre o post se clicar no card, mas não nos botões de admin
            if (postCard && !e.target.closest('.edit-btn') && !e.target.closest('.delete-btn')) {
                openPost(postCard.dataset.id);
            }
            if(e.target.closest('.edit-btn')){
                 openEditForm(e.target.closest('.edit-btn').dataset.id);
            }
            if(e.target.closest('.delete-btn')){
                 handleDeleteClick(e.target.closest('.delete-btn').dataset.id);
            }
            // Listener para o botão de gerenciar aluno
            if(e.target.closest('.manage-student-btn')){
                 openStudentModal(e.target.closest('.manage-student-btn').dataset.id_student);
            }
        });
        
        backToPostsBtn.addEventListener('click', () => {
            stopSpeaking(); // Para o áudio ao voltar
            showView('blog-view');
        });
        postViewEditBtn.addEventListener('click', (e) => openEditForm(e.currentTarget.dataset.id));
        postViewDeleteBtn.addEventListener('click', (e) => handleDeleteClick(e.currentTarget.dataset.id));
        cancelEditBtn.addEventListener('click', () => showView('blog-view')); 
        
        // --- AI FORMATTING (PROMPT MELHORADO) ---
        // Mudança: Prompt mais estrito sobre não alterar conteúdo.
        const systemPrompt = "Você é um editor de texto mágico. Sua ÚNICA função é formatar o texto fornecido para melhor leitura, SEM alterar, adicionar ou remover nenhuma palavra. Regras CRÍTICAS:\n1. Identifique conceitos chave e coloque em negrito (**texto**).\n2. Identifique termos místicos e envolva em ##termo## para destaque.\n3. Mantenha TODA a pontuação, estrutura de parágrafos e conteúdo original. É proibido resumir.\n4. Se houver links de imagem `![legenda](url)`, mantenha-os intactos.\n5. NÃO use cabeçalhos (#) ou listas (-). Apenas use a formatação visual pedida.";

        async function formatTextWithAI(text, apiKey) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            // Lógica de retry (exponential backoff)
            let response;
            let delay = 1000;
            for (let i = 0; i < 3; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        break; // Sucesso
                    }
                    if (response.status === 429) { // Throttling
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        continue;
                    }
                    throw new Error(`API request failed with status ${response.status}`);
                } catch (error) {
                    if (i === 2) throw error; // Lança erro na última tentativa
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            const result = await response.json();
            if (!result.candidates || !result.candidates[0].content) {
                console.error("Resposta inesperada da API:", result);
                throw new Error("Formato de resposta inesperado da API.");
            }
            return result.candidates[0].content.parts[0].text;
        }

        async function handleAIFormat(textareaElement, buttonElement) {
            // Mudança: Usa a chave Hardcoded se existir, senão tenta o input
            const apiKey = HARDCODED_API_KEY || geminiApiKeyInput.value || localStorage.getItem('geminiApiKey');
            
            if (!apiKey) {
                console.error("Chave API não inserida.");
                alert("Por favor, insira sua chave API no painel ou adicione ao código.");
                textareaElement.placeholder = "Por favor, insira sua chave API do Google AI Studio para usar a formatação.";
                return;
            }
            const originalText = textareaElement.value;
            if (!originalText.trim()) return;
            const originalButtonHTML = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Formatando...`;

            try {
                const formattedText = await formatTextWithAI(originalText, apiKey);
                textareaElement.value = formattedText;
            } catch (error) {
                console.error("AI Formatting Error:", error);
                const statusElement = textareaElement.id.includes('create') ? postStatus : editPostStatus;
                if (statusElement) {
                    statusElement.textContent = "Erro ao formatar. Verifique a chave API.";
                    statusElement.className = "text-red-500 mt-2";
                }
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonHTML;
            }
        }

        formatCreateBtn.addEventListener('click', () => handleAIFormat(document.getElementById('post-content'), formatCreateBtn));
        formatEditBtn.addEventListener('click', () => handleAIFormat(document.getElementById('edit-post-content'), formatEditBtn));

        // --- UTILS ---
        function formatPostText(text) {
            if (!text) return '';
            // 1. Sanitização Básica
            let processedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // 2. Imagens no texto: ![legenda](link)
            // É importante processar imagens antes de quebrar linhas ou outras formatações
            processedText = processedText.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, src) => {
                return `<figure class="my-6 text-center">
                            <img src="${src}" alt="${alt}" class="max-w-full h-auto rounded-lg border border-purple-800 shadow-lg mx-auto" onerror="this.style.display='none'">
                            <figcaption class="text-sm text-gray-400 mt-2 italic font-serif">${alt}</figcaption>
                        </figure>`;
            });

            // 3. Remove markdown indesejado (mas mantém o resto)
            processedText = processedText.replace(/^(#+\s*|---\s*$)/gm, ''); // Headers e linhas
            processedText = processedText.replace(/_(.*?)_/g, '$1'); // Remove underscores

            // 4. Formatações de Texto (Negrito, Destaque, Místico)
            const boldFormatted = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            const highlightFormatted = boldFormatted.replace(/\*(.*?)\*/g, '<span class="highlight">$1</span>');
            let finalFormatted = highlightFormatted.replace(/##(.*?)##/g, '<span class="mystic-term">$1</span>');
            
            finalFormatted = finalFormatted.replace(/##/g, ''); // Limpeza final

            // 5. Quebras de linha
            return finalFormatted.replace(/\n/g, '<br>'); 
        }

        function stripMarkdown(text) {
            if (!text) return '';
            // Remove também a sintaxe de imagem do preview
            return text.replace(/!\[(.*?)\]\(.*?\)/g, "[Imagem: $1]").replace(/(\*\*|##|\*|_)/g, "");
        }


        // --- TTS LOGIC (GEMINI AI) ---
        
        // Helper: Convert Base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper: Create WAV Header for PCM Data
        function createWavHeader(dataLength, sampleRate = 24000, numChannels = 1, bitsPerSample = 16) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            
            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            
            // fmt sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true); // ByteRate
            view.setUint16(32, numChannels * (bitsPerSample / 8), true); // BlockAlign
            view.setUint16(34, bitsPerSample, true); // BitsPerSample
            
            // data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            
            return buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // Main Speak Function
        async function speakText() {
             // 1. Se já está tocando (o player está ativo), pause.
            if (!geminiAudioPlayer.paused && geminiAudioPlayer.src) {
                geminiAudioPlayer.pause();
                btnSpeakText.textContent = "Continuar Leitura";
                btnSpeakIcon.className = "fas fa-play";
                audioContainer.classList.remove('audio-playing');
                return;
            }

            // 2. Se está pausado (tem src), retome.
            if (geminiAudioPlayer.paused && geminiAudioPlayer.src && geminiAudioPlayer.currentTime > 0) {
                geminiAudioPlayer.play();
                btnSpeakText.textContent = "Pausar Leitura";
                btnSpeakIcon.className = "fas fa-pause";
                audioContainer.classList.add('audio-playing');
                return;
            }
            
            // 3. Fallback: Verifica se o navegador está falando com a voz robótica antiga (para limpar)
             if (window.speechSynthesis.speaking) {
                 window.speechSynthesis.cancel();
             }

            // 4. Nova Geração:
            // Mudança: Usa a chave Hardcoded se existir
            const apiKey = HARDCODED_API_KEY || geminiApiKeyInput.value || localStorage.getItem('geminiApiKey');
            
            // Fallback para voz do navegador se não tiver API Key
            if (!apiKey) {
                console.warn("Sem API Key. Usando voz do navegador.");
                alert("Para usar a voz natural da Gemini, adicione sua chave API no Painel ou no código. Usando voz padrão...");
                speakTextBrowserFallback();
                return;
            }

            // UI Loading
            const originalBtnText = btnSpeakText.textContent;
            btnSpeakText.textContent = "Invocando a voz...";
            btnSpeakIcon.className = "fas fa-spinner fa-spin";
            btnSpeak.disabled = true;

            // Pega o texto
            const contentDiv = document.getElementById('post-view-content');
            // Remove markdown extra para leitura mais limpa (opcional, mas bom)
            const textToRead = stripMarkdown(contentDiv.innerText).substring(0, 4500); // Limite de segurança

            try {
                // Configuração da API TTS
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: textToRead }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: {
                                    voiceName: "Kore" // Voz feminina, suave
                                }
                            }
                        }
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Erro na API: ${response.status}`);
                
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].inlineData) {
                    const audioData = result.candidates[0].content.parts[0].inlineData;
                    const base64PCM = audioData.data;
                    
                    // Convert PCM to WAV
                    const pcmBuffer = base64ToArrayBuffer(base64PCM);
                    const wavHeader = createWavHeader(pcmBuffer.byteLength, 24000); // Gemini usa 24kHz por padrão
                    
                    const wavBlob = new Blob([wavHeader, pcmBuffer], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    // Setup Player
                    geminiAudioPlayer.src = audioUrl;
                    
                    // Listeners para UI
                    geminiAudioPlayer.onplay = () => {
                         btnSpeakText.textContent = "Pausar Leitura";
                         btnSpeakIcon.className = "fas fa-pause";
                         btnStopSpeak.classList.remove('hidden');
                         audioContainer.classList.add('audio-playing');
                    };
                    
                    geminiAudioPlayer.onpause = () => {
                        if(geminiAudioPlayer.currentTime < geminiAudioPlayer.duration && !geminiAudioPlayer.ended){
                             btnSpeakText.textContent = "Continuar Leitura";
                             btnSpeakIcon.className = "fas fa-play";
                             audioContainer.classList.remove('audio-playing');
                        }
                    };

                    geminiAudioPlayer.onended = () => {
                        stopSpeaking();
                    };

                    await geminiAudioPlayer.play();

                } else {
                    throw new Error("Formato de resposta inválido.");
                }

            } catch (error) {
                console.error("Erro no TTS da Gemini:", error);
                alert("Não foi possível gerar a voz mística. Usando voz padrão.");
                speakTextBrowserFallback(); // Fallback
            } finally {
                btnSpeak.disabled = false;
                if(geminiAudioPlayer.paused && !geminiAudioPlayer.src) {
                     btnSpeakText.textContent = "Ouvir o Chamado";
                     btnSpeakIcon.className = "fas fa-volume-up";
                }
            }
        }

        // Função Antiga (Fallback)
        function speakTextBrowserFallback() {
             const contentDiv = document.getElementById('post-view-content');
             if (!contentDiv) return;
             const textToRead = contentDiv.innerText;
             const utterance = new SpeechSynthesisUtterance(textToRead);
             utterance.lang = 'pt-BR';
             utterance.rate = 1.0; 
             
             utterance.onstart = () => {
                btnSpeakText.textContent = "Pausar Leitura";
                btnSpeakIcon.className = "fas fa-pause";
                btnStopSpeak.classList.remove('hidden');
            };
            utterance.onend = () => {
                btnSpeakText.textContent = "Ouvir o Chamado";
                btnSpeakIcon.className = "fas fa-volume-up";
                btnStopSpeak.classList.add('hidden');
            };
             window.speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            // Stop Gemini Audio
            if(geminiAudioPlayer.src) {
                geminiAudioPlayer.pause();
                geminiAudioPlayer.currentTime = 0;
                geminiAudioPlayer.src = ""; // Unload
            }
            
            // Stop Browser Audio
            if (window.speechSynthesis.speaking || window.speechSynthesis.pending) {
                window.speechSynthesis.cancel();
            }
            
            // Reset UI
            if(btnSpeakText) btnSpeakText.textContent = "Ouvir o Chamado";
            if(btnSpeakIcon) btnSpeakIcon.className = "fas fa-volume-up";
            if(btnStopSpeak) btnStopSpeak.classList.add('hidden');
            if(audioContainer) audioContainer.classList.remove('audio-playing');
        }

        btnSpeak.addEventListener('click', speakText);
        btnStopSpeak.addEventListener('click', stopSpeaking);

    </script>
</body>
</html>
