<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Coven do Corvo | Santu√°rio Digital</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // üîÆ CONFIGURA√á√ÉO DO SACERDOTE üîÆ
        // Op√ß√µes: 'Yule', 'Imbolc', 'Ostara', 'Beltane', 'Litha', 'Lammas', 'Mabon', 'Samhain', 'AnoNovo'
        // ESPECIAL: Se escolher 'Hekate', ele alterna automaticamente com 'Nyx' (Os Dois Pilares)
        const CURRENT_THEME = 'Ostara'; 

        // BANCO DE DADOS DE EST√âTICA
        const THEMES = {
            'Yule': {
                name: 'Yule', 
                primary: { 400: '#D4AF37', 500: '#C5A028', 900: '#3D3008' }, // Dourado
                accent: '#8B0000', // Vermelho Sanguae
                particle: '‚ùÑ', // Neve
                particleColor: '#FFFFFF',
                particleDirection: 'down'
            },
            'Imbolc': {
                name: 'Imbolc',
                primary: { 400: '#A5F2F3', 500: '#7CD1D3', 900: '#1A4D4F' }, // Gelo/Ciano
                accent: '#7CD1D3', // Branco Puro
                particle: '‚ú®', // Brilho
                particleColor: '#A5F2F3',
                particleDirection: 'up'
            },
            'Ostara': {
                name: 'Ostara',
                primary: { 400: '#90EE90', 500: '#77DD77', 900: '#1A4F1A' }, // Verde Claro
                accent: '#FFB7C5', // Rosa Flor
                particle: 'üå∏', // Flor
                particleColor: '#FFB7C5',
                particleDirection: 'down'
            },
            'Beltane': {
                name: 'Beltane',
                primary: { 400: '#FF2400', 500: '#DD2400', 900: '#4F0A00' }, // Vermelho Fogo
                accent: '#50C878', // Verde Esmeralda
                particle: 'üî•', // Fogo
                particleColor: '#FF4500',
                particleDirection: 'up'
            },
            'Litha': {
                name: 'Litha',
                primary: { 400: '#FFD700', 500: '#FFC000', 900: '#5C4800' }, // Amarelo Sol
                accent: '#FFA500', // Laranja
                particle: '‚òÄÔ∏è', // Sol
                particleColor: '#FFD700',
                particleDirection: 'up'
            },
            'Lammas': {
                name: 'Lammas',
                primary: { 400: '#F4C430', 500: '#DAA520', 900: '#5C4000' }, // Trigo/Dourado
                accent: '#D2691E', // Marrom/Laranja
                particle: 'üåæ', // Trigo
                particleColor: '#F4C430',
                particleDirection: 'down'
            },
            'Mabon': {
                name: 'Mabon',
                primary: { 400: '#D2691E', 500: '#8B4513', 900: '#3D1F00' }, // Marrom
                accent: '#800080', // Roxo
                particle: 'üçÇ', // Folha
                particleColor: '#D2691E',
                particleDirection: 'down'
            },
            'Samhain': {
                name: 'Samhain',
                primary: { 400: '#9370DB', 500: '#8A2BE2', 900: '#2E004F' }, // Roxo
                accent: '#FF4500', // Laranja Ab√≥bora
                particle: 'üëª', // Fantasma
                particleColor: '#FFFFFF',
                particleDirection: 'up'
            },
            // TEMA ESPECIAL: ANO NOVO (COM FOGOS)
            'AnoNovo': {
                name: 'Ano Novo',
                primary: { 400: '#E5E4E2', 500: '#C0C0C0', 900: '#1C1C1C' }, // Platina/Prata
                accent: '#D4AF37', // Dourado Champanhe
                particle: 'fireworks', // ATIVADOR DE FOGOS
                particleColor: '#FFD700', // Ouro
                particleDirection: 'up' 
            },
            // PILAR 1: HEKATE (Prata e Cinza)
            'Hekate': {
                name: 'Hekate',
                primary: { 400: '#C0C0C0', 500: '#A9A9A9', 900: '#2F2F2F' }, // Prata/Cinza
                accent: '#DAA520', // Dourado Envelhecido (Tochas)
                particle: 'üîë', // Chave
                particleColor: '#C0C0C0',
                particleDirection: 'up'
            },
            // PILAR 2: NYX (Azul Noite Profunda e Estrelas)
            'Nyx': {
                name: 'Nyx',
                primary: { 400: '#818CF8', 500: '#4F46E5', 900: '#1E1B4B' }, // √çndigo/Midnight
                accent: '#E0E7FF', // Brilho Estelar
                particle: '‚ú¶', // Estrela
                particleColor: '#FFFFFF',
                particleDirection: 'down' // Estrelas caindo
            }
        };

        // L√ìGICA DOS PILARES (Alterna Hekate/Nyx)
        let themeKey = CURRENT_THEME;
        
        if (CURRENT_THEME === 'Hekate') {
            // Verifica quem apareceu por √∫ltimo
            const lastPillar = localStorage.getItem('coven_pillar_toggle');
            
            if (lastPillar === 'Hekate') {
                themeKey = 'Nyx';
                localStorage.setItem('coven_pillar_toggle', 'Nyx');
            } else {
                themeKey = 'Hekate';
                localStorage.setItem('coven_pillar_toggle', 'Hekate');
            }
            console.log("Os Pilares Giraram: Agora rege " + themeKey);
        }

        const activeTheme = THEMES[themeKey] || THEMES['Yule'];

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: '#050505',
                        primary: activeTheme.primary,
                        obsidian: '#0f0f10',
                        accent: activeTheme.accent,
                    },
                    fontFamily: {
                        display: ['Cinzel', 'serif'],
                        body: ['Lato', 'sans-serif'],
                    },
                    animation: { 'bounce-slow': 'bounce 3s infinite' }
                }
            }
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        /* ESTILOS GERAIS */
        body { background-color: #050505; color: #e5e5e5; overflow-x: hidden; }
        
        /* Scrollbar Din√¢mica */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--accent-color, #8B0000), var(--primary-color, #D4AF37)); border-radius: 3px; }

        .glass-dark {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Classes Utilit√°rias do Tema (CSS Variables injetadas via JS depois) */
        .text-gradient-theme {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-light), var(--primary-main));
            -webkit-background-clip: text; background-clip: text; color: transparent; background-size: 200% auto; animation: shine 5s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        #intro-sequence { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        
        /* CARDS */
        .project-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        /* Icone do festival no canto do card */
        .project-card::after {
            content: var(--theme-icon, '‚ùÑÔ∏è'); 
            position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.3; filter: grayscale(0.5) sepia(1) hue-rotate(-50deg); transition: 0.4s;
        }
        .project-card:hover::after { opacity: 0.8; filter: none; transform: rotate(15deg); }
        .project-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-main);
            box-shadow: 0 10px 40px -10px rgba(255, 255, 255, 0.1), 0 0 20px var(--accent-color-alpha);
        }
        
        .input-luxe { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: #fff; transition: 0.3s; }
        .input-luxe:focus { outline: none; border-color: var(--primary-main); background: rgba(255, 255, 255, 0.05); }

        /* SELE√á√ÉO DE AVATAR */
        .avatar-option input[type="radio"] { display: none; }
        .avatar-option label { 
            display: flex; align-items: center; justify-content: center; 
            width: 50px; height: 50px; border-radius: 50%; 
            border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.3s;
            color: #666; font-size: 1.2rem;
        }
        .avatar-option input[type="radio"]:checked + label {
            background: var(--primary-main); color: #000; box-shadow: 0 0 15px var(--primary-main);
        }

        /* CORVO SVG ANIMADO */
        .mystic-crow-svg {
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.2));
            animation: hoverCrow 4s ease-in-out infinite alternate;
        }
        .crow-wing-left { transform-origin: center; animation: flapLeft 1.2s ease-in-out infinite alternate; }
        .crow-wing-right { transform-origin: center; animation: flapRight 1.2s ease-in-out infinite alternate; }
        
        @keyframes hoverCrow { 0% { transform: translateY(0); } 100% { transform: translateY(-15px); } }
        @keyframes flapLeft { 0% { transform: rotate(0deg) translateY(0); } 100% { transform: rotate(-10deg) translateY(5px); } }
        @keyframes flapRight { 0% { transform: rotate(0deg) translateY(0); } 100% { transform: rotate(10deg) translateY(5px); } }
        
        /* PARTICLES CONTAINER */
        .particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }
        .particle {
            position: absolute; opacity: 0;
            animation: particleAnim linear infinite;
        }
        @keyframes particleAnim {
            0% { opacity: 0; transform: translateY(var(--start-y)) rotate(0deg); }
            20% { opacity: 0.7; }
            100% { opacity: 0; transform: translateY(var(--end-y)) rotate(360deg); }
        }

        /* FIREWORKS CANVAS */
        #fireworks-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* --- SISTEMA DE TRILHA (PATH SYSTEM v2) --- */
        .path-container-wrapper {
            position: relative;
            width: 100%;
            /* Ajuste para n√£o cortar no PC mas proteger Mobile */
            overflow-x: hidden; 
            min-height: 600px;
            display: flex;
            justify-content: center;
            padding-top: 40px;
            padding-bottom: 100px;
        }

        .path-svg-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;
        }

        .path-node-wrapper {
            position: absolute;
            transform: translate(-50%, -50%); 
            z-index: 2;
            display: flex;
            flex-col: column;
            align-items: center;
        }

        .game-node {
            width: 70px; height: 70px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 0 rgba(0,0,0,0.5); 
        }
        
        @media (max-width: 640px) {
            .game-node { width: 60px; height: 60px; font-size: 1.5rem; box-shadow: 0 4px 0 rgba(0,0,0,0.5); }
            .game-node:active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0,0,0,0.5); }
            .node-label { top: 70px; font-size: 0.65rem; }
            .game-node.status-active + .node-label { top: 75px; }
        }

        .game-node:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.5); }

        /* STATUS */
        .game-node.status-completed {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-main));
            border: 4px solid #FFD700; color: #000;
            box-shadow: 0 6px 0 #b8860b, 0 0 20px var(--primary-main);
        }

        .game-node.status-active {
            background: var(--accent-color);
            border: 4px solid #fff; color: #fff;
            box-shadow: 0 6px 0 #500000, 0 0 30px var(--accent-color);
            animation: pulseActive 2s infinite;
        }
        @keyframes pulseActive {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        .game-node.status-locked {
            background: #1a1a1a;
            border: 4px solid #333; color: #444;
            cursor: not-allowed;
            box-shadow: 0 6px 0 #000;
        }
        .game-node.status-locked:active { transform: none; box-shadow: 0 6px 0 #000; }

        /* Label Tooltip Normal */
        .node-label {
            position: absolute; top: 85px;
            background: #fff; color: #000;
            padding: 5px 10px; border-radius: 8px;
            font-family: 'Lato', sans-serif; font-weight: bold; font-size: 0.75rem;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            opacity: 0; transform: translateY(-10px); transition: 0.3s; pointer-events: none;
            
            /* Corre√ß√£o para texto n√£o cortar no celular */
            white-space: normal;
            text-align: center;
            min-width: 120px;
            max-width: 180px;
            line-height: 1.2;
            left: 50%; 
            transform: translateX(-50%); /* Centraliza */
        }
        .node-label::before {
            content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            border-width: 0 5px 5px 5px; border-style: solid; border-color: transparent transparent #fff transparent;
        }
        .path-node-wrapper:hover .node-label { opacity: 1; transform: translateY(0); }
        /* Quando ativo, a label sobe com o elemento */
        .game-node.status-active + .node-label { opacity: 1; transform: translateX(-50%) translateY(0); top: 90px; }

        /* TOOLTIP BLOQUEADO (NOVO) */
        .locked-tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-10px);
            background: #2a0a0a; color: #ff6b6b; border: 1px solid #500;
            padding: 8px 12px; border-radius: 4px;
            font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; text-align: center;
            width: 140px; pointer-events: none; opacity: 0; transition: opacity 0.3s, transform 0.3s;
            z-index: 30; box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        }
        .locked-tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            border-width: 5px 5px 0 5px; border-style: solid; border-color: #500 transparent transparent transparent;
        }
        .path-node-wrapper:hover .game-node.status-locked ~ .locked-tooltip { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ESTRELAS E DECORA√á√ÉO */
        .stars-container { position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; }
        
        /* ANIMA√á√ÉO DE DESBLOQUEIO (CELEBRA√á√ÉO) */
        .celebration-unlock {
            animation: unlockFlash 1.5s ease-out forwards;
        }
        @keyframes unlockFlash {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); background: var(--accent-color); filter: brightness(1); }
            50% { transform: scale(1.3); box-shadow: 0 0 50px 20px rgba(212, 175, 55, 0.8); background: #FFD700; filter: brightness(2); border-color: white; }
            100% { transform: scale(1); box-shadow: 0 6px 0 #b8860b, 0 0 20px var(--primary-main); filter: brightness(1); }
        }

        /* √çCONE FLUTUANTE DE AVATAR (NOVO) */
        .path-avatar-float {
            position: absolute; top: -55px; left: 50%; transform: translateX(-50%);
            z-index: 20; pointer-events: none;
            filter: drop-shadow(0 0 10px rgba(255,215,0,0.4));
        }
        .path-avatar-icon { font-size: 2.5rem; animation: bounceAvatar 2s infinite ease-in-out; color: var(--accent-color); }
        .path-avatar-arrow { color: var(--accent-color); text-align: center; margin-top: -5px; animation: pulse 1s infinite; font-size: 0.8rem; }
        
        @keyframes bounceAvatar {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

    </style>
</head>
<body class="antialiased">

    <div class="particle-container" id="particles"></div>
    <script>
        const root = document.documentElement;
        root.style.setProperty('--primary-main', activeTheme.primary[400]);
        root.style.setProperty('--primary-light', activeTheme.primary[500]);
        root.style.setProperty('--primary-dark', activeTheme.primary[900]);
        root.style.setProperty('--accent-color', activeTheme.accent);
        
        // --- SISTEMA DE PART√çCULAS H√çBRIDO (DOM ou CANVAS) ---
        const pContainer = document.getElementById('particles');
        
        if (activeTheme.particle === 'fireworks') {
            // === MODO FOGOS DE ARTIF√çCIO (CANVAS) ===
            const canvas = document.createElement('canvas');
            canvas.id = 'fireworks-canvas';
            pContainer.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            
            let width = window.innerWidth;
            let height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;

            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
            });

            class Particle {
                constructor(x, y, color) {
                    this.x = x;
                    this.y = y;
                    this.color = color;
                    this.speed = Math.random() * 5 + 1;
                    this.angle = Math.random() * Math.PI * 2;
                    this.vx = Math.cos(this.angle) * this.speed;
                    this.vy = Math.sin(this.angle) * this.speed;
                    this.alpha = 1;
                    this.decay = Math.random() * 0.015 + 0.005;
                    this.gravity = 0.05;
                }
                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.alpha;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
                update() {
                    this.vx *= 0.95; // atrito
                    this.vy *= 0.95;
                    this.vy += this.gravity;
                    this.x += this.vx;
                    this.y += this.vy;
                    this.alpha -= this.decay;
                }
            }

            class Rocket {
                constructor() {
                    this.x = Math.random() * width;
                    this.y = height;
                    this.targetY = Math.random() * (height * 0.5); // Explode na metade superior
                    this.speed = Math.random() * 3 + 8; // Velocidade de subida
                    this.color = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    this.exploded = false;
                }
                draw() {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    // Rastro
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y + 5, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
                update() {
                    this.y -= this.speed;
                    if(this.y <= this.targetY) {
                        this.exploded = true;
                    }
                }
            }

            let rockets = [];
            let particles = [];

            function loop() {
                // Rastro suave
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // Quanto menor alpha, maior o rastro
                ctx.fillRect(0, 0, width, height);
                ctx.globalCompositeOperation = 'lighter';

                // Lan√ßa foguetes aleatoriamente
                if (Math.random() < 0.03) { // Frequ√™ncia de lan√ßamentos
                    rockets.push(new Rocket());
                }

                // Atualiza foguetes
                for (let i = rockets.length - 1; i >= 0; i--) {
                    rockets[i].update();
                    rockets[i].draw();
                    if (rockets[i].exploded) {
                        // Cria explos√£o
                        for (let j = 0; j < 40; j++) { // Qtd de particulas por explos√£o
                            particles.push(new Particle(rockets[i].x, rockets[i].y, rockets[i].color));
                        }
                        rockets.splice(i, 1);
                    }
                }

                // Atualiza part√≠culas da explos√£o
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    particles[i].draw();
                    if (particles[i].alpha <= 0) {
                        particles.splice(i, 1);
                    }
                }

                requestAnimationFrame(loop);
            }
            loop();

        } else {
            // === MODO PART√çCULAS PADR√ÉO (DOM - EMOJIS) ===
            root.style.setProperty('--theme-icon', `'${activeTheme.particle}'`);
            const pCount = 40; 
            const isUp = activeTheme.particleDirection === 'up';

            for (let i = 0; i < pCount; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.innerHTML = activeTheme.particle;
                p.style.left = Math.random() * 100 + '%';
                if(isUp) {
                    p.style.bottom = '-20px'; p.style.setProperty('--start-y', '0'); p.style.setProperty('--end-y', '-100vh');
                } else {
                    p.style.top = '-20px'; p.style.setProperty('--start-y', '0'); p.style.setProperty('--end-y', '100vh');
                }
                p.style.animationDuration = Math.random() * 10 + 5 + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                p.style.fontSize = Math.random() * 10 + 8 + 'px';
                p.style.color = Math.random() > 0.7 ? activeTheme.primary[400] : activeTheme.particleColor;
                pContainer.appendChild(p);
            }
        }
    </script>

    <div id="intro-sequence">
        <div style="width: 100%; max-width: 1000px; padding: 20px;"> 
            <div style="padding:56.25% 0 0 0;position:relative;">
                <iframe src="https://player.vimeo.com/video/1167449229?badge=0&autopause=0&player_id=0&app_id=58479&autoplay=1&muted=1&controls=0&title=0&byline=0&portrait=0" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" style="position:absolute;top:0;left:0;width:100%;height:100%;" title="Intro"></iframe>
            </div>
            <button onclick="forceOpenSite()" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 text-gray-500 text-[10px] uppercase tracking-widest hover:text-white transition z-50">
                Pular Intro
            </button>
        </div>
    </div>

    <div id="app-root" style="display: none; opacity: 0;">
        
        <div id="loading-spinner" class="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center hidden">
            <div class="relative animate-bounce mb-4">
                <i class="fas fa-crow text-4xl text-primary-400"></i>
                <i class="fas fa-certificate absolute -top-2 -right-2 text-accent text-sm animate-spin"></i>
            </div>
            <p class="text-primary-400 text-xs tracking-[0.3em] uppercase animate-pulse">Carregando Magia...</p>
        </div>

        <header class="fixed top-0 w-full z-40 bg-void/90 backdrop-blur border-b border-primary-900/30 h-20 transition-all duration-300">
            <div class="container mx-auto px-6 h-full flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="showView('home-view')">
                    <img src="https://i.ibb.co/2705r709/Black-Friday.png" alt="Logo" class="h-10 w-auto opacity-80 group-hover:opacity-100 transition filter drop-shadow-[0_0_5px_rgba(212,175,55,0.3)]">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-primary-400 uppercase tracking-[0.3em]">O Coven do</span>
                        <h1 class="text-lg font-display text-white tracking-widest group-hover:text-primary-400 transition flex items-center gap-2">CORVO <i class="fas fa-moon text-accent text-xs opacity-50 group-hover:opacity-100 transition"></i></h1>
                    </div>
                </div>

                <nav class="hidden md:flex items-center space-x-8">
                    <button data-view="home-view" class="internal-link text-xs font-display font-bold tracking-[0.2em] text-gray-400 hover:text-white uppercase transition">Santu√°rio</button>
                    <button data-view="blog-view" class="internal-link text-xs font-display font-bold tracking-[0.2em] text-gray-400 hover:text-white uppercase transition">Grim√≥rio</button>

                    <button data-view="feed-view" class="internal-link text-xs font-display font-bold tracking-[0.2em] text-primary-500 hover:text-white uppercase transition drop-shadow-[0_0_5px_rgba(212,175,55,0.5)]"><i class="fas fa-scroll mr-1"></i> Mural</button>

                    <button data-view="sobre-view" class="internal-link text-xs font-display font-bold tracking-[0.2em] text-gray-400 hover:text-white uppercase transition">Sacerdote</button>
                    <div class="w-[1px] h-4 bg-white/10"></div>
                    <a href="https://ardanraven.github.io/Calendario/" target="_blank" class="text-gray-400 hover:text-primary-400" title="Calend√°rio"><i class="fas fa-moon"></i></a>
                    <a href="https://caminhodatocha.site" target="_blank" class="border border-primary-900/50 text-primary-400 px-5 py-2 text-[10px] uppercase tracking-widest hover:bg-primary-900 hover:text-white transition font-bold relative overflow-hidden group">
                        <span class="relative z-10">Fazer Parte do Coven</span>
                        <div class="absolute inset-0 bg-gradient-to-r from-accent/20 to-primary-900/20 opacity-0 group-hover:opacity-100 transition"></div>
                    </a>
                </nav>

                <div class="flex items-center gap-4">
                    <div id="user-info" class="hidden items-center gap-3">
                        <button onclick="showView('profile-view')" class="flex items-center gap-2 text-gray-400 hover:text-primary-400 transition group">
                            <i id="header-user-icon" class="fas fa-user-circle"></i>
                            <span id="header-user-name" class="text-[10px] hidden sm:inline uppercase tracking-widest group-hover:underline">Iniciado</span>
                        </button>
                        <div class="w-[1px] h-3 bg-white/10 mx-1"></div>
                        <button id="logout-btn" class="text-gray-400 hover:text-red-500 text-xs" title="Sair"><i class="fas fa-power-off"></i></button>
                    </div>
                    <button id="login-btn" class="hidden text-xs font-display text-primary-400 uppercase tracking-widest hover:text-white border-b border-transparent hover:border-primary-400 pb-1">Login</button>
                    <button id="mobile-menu-btn" class="md:hidden text-primary-400 text-xl"><i class="fas fa-bars"></i></button>
                </div>
            </div>
        </header>

        <div id="mobile-menu" class="hidden fixed inset-0 z-30 bg-black pt-24 px-8 md:hidden">
            <div class="flex flex-col gap-6 text-center">
                <button data-view="home-view" class="internal-link text-2xl font-display text-white py-2 border-b border-white/10">Santu√°rio</button>
                <button data-view="blog-view" class="internal-link text-2xl font-display text-white py-2 border-b border-white/10">Grim√≥rio</button>
                <button data-view="sobre-view" class="internal-link text-2xl font-display text-white py-2 border-b border-white/10">Sacerdote</button>
                <button data-view="profile-view" class="internal-link text-primary-400 text-xl font-display py-2"><i class="fas fa-user mr-2"></i>Meu Perfil</button>
                <a href="https://caminhodatocha.site" class="text-primary-400 text-xl font-display py-2"><i class="fas fa-gift mr-2"></i>Coven</a>
                <button onclick="document.getElementById('mobile-menu').classList.add('hidden')" class="text-gray-500 mt-8 uppercase text-xs">Fechar</button>
            </div>
        </div>

        <main class="pt-20 min-h-screen relative z-10">
            
            <div id="home-view" class="view-container">
                
                <section class="relative min-h-[85vh] flex flex-col items-center justify-center text-center px-4 overflow-hidden">
                    <div class="absolute inset-0 z-0 opacity-30 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-accent/20 via-obsidian to-black"></div>
                    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-primary-900/10 rounded-full blur-[100px] pointer-events-none animate-pulse"></div>
                    
                    <div class="relative z-10 max-w-4xl mx-auto space-y-6">
                        <div class="flex justify-center mb-4 relative">
                            <i class="fas fa-star-of-life text-2xl text-primary-500 animate-spin-slow opacity-50"></i>
                        </div>
                        <h2 class="text-primary-500 text-xs md:text-sm tracking-[0.6em] uppercase fade-in-up flex items-center justify-center gap-3" style="animation-delay: 0.1s">
                            <span class="h-[1px] w-8 bg-primary-500"></span> <script>document.write(activeTheme.name)</script> <span class="h-[1px] w-8 bg-primary-500"></span>
                        </h2>
                        <h1 class="text-5xl md:text-7xl lg:text-9xl font-display font-black text-white leading-tight fade-in-up" style="animation-delay: 0.3s">
                            O COVEN DO <br><span class="text-gradient-theme">CORVO</span>
                        </h1>
                        <div class="h-[1px] w-24 bg-gradient-to-r from-transparent via-accent to-transparent mx-auto my-6 fade-in-up" style="animation-delay: 0.5s"></div>
                        <p class="text-gray-300 max-w-2xl mx-auto text-lg md:text-xl font-body font-light leading-relaxed fade-in-up" style="animation-delay: 0.6s">
                            Neste ciclo sagrado, os caminhos se cruzam e a magia antiga sussurra. <br>
                            Seja bem-vindo a nossa plataforma de Estudos.
                        </p>
                        <div class="pt-8 flex flex-col md:flex-row gap-6 justify-center items-center fade-in-up" style="animation-delay: 0.8s">
                            <button data-view="blog-view" class="internal-link px-10 py-4 bg-transparent border border-primary-400 text-primary-400 font-display text-sm font-bold tracking-[0.2em] uppercase hover:bg-primary-900/50 hover:text-white transition shadow-[0_0_20px_rgba(255,255,255,0.1)] relative group overflow-hidden">
                                <span class="relative z-10">Abrir o Grim√≥rio</span>
                                <div class="absolute inset-0 bg-gradient-to-r from-accent/10 to-primary-500/10 opacity-0 group-hover:opacity-100 transition"></div>
                            </button>
                        </div>
                    </div>
                </section>

                <section id="about-section" class="py-24 px-6 bg-obsidian border-t border-primary-900/30 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-accent/5 via-transparent to-transparent pointer-events-none"></div>

                    <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-16 items-center relative z-10">
                        <div class="order-2 md:order-1 space-y-8 text-justify">
                            <h3 class="text-3xl font-display text-white flex items-center gap-4">
                                <i class="fas fa-gift text-accent text-2xl"></i> O Mensageiro Festivo
                            </h3>
                            <p class="text-gray-400 font-body leading-loose text-lg">
                                Nas sombras e na luz dos festivais, o <strong>Corvo</strong> vigia. Antigamente, eles eram os olhos dos deuses; hoje, trazem os presentes do conhecimento oculto.
                            </p>
                            <p class="text-gray-400 font-body leading-loose text-lg">
                                Hekate, a Senhora das Encruzilhadas, segura as chaves do cosmos e aben√ßoa este ciclo. Este blog √© o nosso ponto de encontro para celebrar a Roda do Ano.
                            </p>
                            <div class="pt-4 flex items-center gap-4">
                                <i class="fas fa-key text-primary-500"></i>
                                <p class="text-primary-400 font-display text-sm tracking-widest uppercase">B√™n√ß√£os de <script>document.write(activeTheme.name)</script>, Sacerdote Leonardo</p>
                            </div>
                        </div>
                        <div class="order-1 md:order-2 flex justify-center relative h-96 items-center">
                             <div class="absolute inset-0 bg-gradient-to-br from-primary-500/10 to-accent/10 blur-[100px] rounded-full pointer-events-none animate-pulse"></div>
                            
                            <svg class="mystic-crow-svg w-full h-full max-w-md" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="crowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#3a3a3a;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#0a0a0a;stop-opacity:1" />
                                    </linearGradient>
                                    <filter id="goldGlow">
                                        <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                        <feMerge>
                                            <feMergeNode in="coloredBlur"/>
                                            <feMergeNode in="SourceGraphic"/>
                                        </feMerge>
                                    </filter>
                                </defs>
                                
                                <g class="crow-body" fill="url(#crowGradient)" stroke="var(--primary-main)" stroke-width="1.5" filter="url(#goldGlow)">
                                    <path d="M250,200 C220,250 230,350 250,400 C270,350 280,250 250,200 Z" />
                                    <path d="M250,200 C230,180 230,150 250,130 C270,150 270,180 250,200 Z" />
                                    <path d="M250,130 L240,110 L260,110 Z" fill="var(--primary-main)"/>
                                    
                                    <g class="crow-wing-left">
                                        <path d="M230,220 C150,200 50,150 20,100 C80,150 180,250 230,280 Z" opacity="0.9"/>
                                        <path d="M235,230 C160,220 70,180 40,130 C100,180 190,260 235,290 Z" opacity="0.7"/>
                                    </g>

                                    <g class="crow-wing-right">
                                        <path d="M270,220 C350,200 450,150 480,100 C420,150 320,250 270,280 Z" opacity="0.9"/>
                                         <path d="M265,230 C340,220 430,180 460,130 C400,180 310,260 265,290 Z" opacity="0.7"/>
                                    </g>
                                    
                                    <circle cx="250" cy="165" r="5" fill="var(--primary-main)" filter="url(#goldGlow)"/>
                                </g>
                            </svg>
                        </div>
                    </div>
                </section>

                <section class="py-24 px-6 bg-void relative overflow-hidden">
                    <div class="absolute top-0 w-full h-[1px] bg-gradient-to-r from-transparent via-accent/30 to-transparent"></div>
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-16 space-y-4">
                            <i class="fas fa-holly-berry text-primary-500 text-2xl"></i>
                            <h3 class="text-4xl font-display text-white">Presentes do Templo</h3>
                            <p class="text-gray-500 text-sm uppercase tracking-widest">Projetos e Caminhos</p>
                        </div>

                        <div class="grid md:grid-cols-3 gap-8">
                            <div class="project-card bg-obsidian border border-white/5 p-8 relative group cursor-pointer" onclick="showView('blog-view')">
                                <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-30 transition duration-500">
                                    <i class="fas fa-book-open text-7xl text-primary-900"></i>
                                </div>
                                <h4 class="text-xl font-display text-primary-400 mb-4 group-hover:text-white transition flex items-center gap-2">O Grim√≥rio <i class="fas fa-star text-[10px] text-accent opacity-50 group-hover:opacity-100 transition"></i></h4>
                                <p class="text-gray-400 text-sm leading-relaxed mb-8 min-h-[80px]">
                                    O cora√ß√£o deste santu√°rio. Artigos profundos e rituais para celebrar a roda do ano.
                                </p>
                                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest group-hover:text-primary-400 transition flex items-center gap-2">Ler Agora <i class="fas fa-arrow-right"></i></span>
                            </div>

                            <a href="https://caminhodatocha.site" target="_blank" class="project-card bg-obsidian border border-white/5 p-8 relative group block">
                                <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-30 transition duration-500">
                                    <i class="fas fa-fire text-7xl text-accent"></i>
                                </div>
                                <h4 class="text-xl font-display text-primary-400 mb-4 group-hover:text-white transition flex items-center gap-2">Coven do Corvo <i class="fas fa-gift text-[10px] text-accent opacity-50 group-hover:opacity-100 transition"></i></h4>
                                <p class="text-gray-400 text-sm leading-relaxed mb-8 min-h-[80px]">
                                    O maior presente que voc√™ pode se dar: conhecimento estruturado. Um mergulho profundo nos mist√©rios.
                                </p>
                                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest group-hover:text-primary-400 transition flex items-center gap-2">Saber Mais <i class="fas fa-external-link-alt"></i></span>
                            </a>

                            <a href="https://ardanraven.github.io/Calendario/" target="_blank" class="project-card bg-obsidian border border-white/5 p-8 relative group block">
                                <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-30 transition duration-500">
                                    <i class="fas fa-calendar-alt text-7xl text-primary-900"></i>
                                </div>
                                <h4 class="text-xl font-display text-primary-400 mb-4 group-hover:text-white transition flex items-center gap-2">Calend√°rio Hekatino <i class="fas fa-snowflake text-[10px] text-accent opacity-50 group-hover:opacity-100 transition"></i></h4>
                                <p class="text-gray-400 text-sm leading-relaxed mb-8 min-h-[80px]">
                                    Sincronize-se com os ciclos. Mapeie os dias sagrados e os rituais espec√≠ficos.
                                </p>
                                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest group-hover:text-primary-400 transition flex items-center gap-2">Acessar <i class="fas fa-external-link-alt"></i></span>
                            </a>
                        </div>
                    </div>
                </section>

                <section class="py-20 px-6 border-t border-primary-900/30 bg-[#080808] text-center relative overflow-hidden">
                     <div class="absolute inset-0 bg-gradient-to-t from-accent/10 to-primary-500/5 blur-[120px] pointer-events-none"></div>
                    <div class="max-w-2xl mx-auto space-y-8 relative z-10">
                        <i class="fas fa-key text-3xl text-primary-500 animate-pulse"></i>
                        <h3 class="text-3xl font-display text-white">Junte-se √† Celebra√ß√£o do Coven</h3>
                        <p class="text-gray-400 font-body leading-relaxed">
                            Nestes dias sagrados, alguns segredos s√£o compartilhados apenas entre os iniciados. <br>
                            Se voc√™ possui a chave, adentre o c√≠rculo interno.
                        </p>
                        <button onclick="document.getElementById('login-view').style.display='flex'" class="inline-block border border-primary-900 px-10 py-4 text-primary-400 font-display text-xs font-bold tracking-[0.3em] uppercase hover:bg-accent/80 hover:text-white hover:border-accent transition relative group overflow-hidden">
                            <span class="relative z-10">√Årea Restrita</span>
                             <div class="absolute inset-0 bg-primary-400/10 opacity-0 group-hover:opacity-100 transition"></div>
                        </button>
                    </div>
                </section>
            </div>

            <div id="blog-view" class="view-container hidden max-w-7xl mx-auto pt-10 px-4">
                
                <!-- PAINEL DE ADMIN (VIS√çVEL APENAS PARA O SACERDOTE) -->
                <div id="admin-panel" class="hidden mb-16 p-8 bg-obsidian border border-primary-900/30 rounded-sm relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 text-9xl text-white/5 pointer-events-none"><i class="fas fa-feather"></i></div>
                    <h3 class="text-primary-400 font-display text-xl mb-6 flex items-center gap-2 relative z-10"><i class="fas fa-crown"></i> Painel do Sacerdote</h3>
                    
                    <div class="grid lg:grid-cols-2 gap-10 relative z-10">
                        <form id="create-post-form" class="space-y-4">
                            <input type="text" id="post-title" class="input-luxe w-full p-3 font-display text-lg" placeholder="T√≠tulo do Ritual" required>
                            <div class="relative">
                                <input type="text" id="post-cover-image" class="input-luxe w-full p-3 font-body text-sm pr-24" placeholder="Link da Imagem gerado..." required readonly>
                                <input type="file" id="post-cover-file" accept="image/*" class="hidden">
                                <button type="button" onclick="document.getElementById('post-cover-file').click()" class="absolute right-2 top-2 bg-primary-900 text-white px-4 py-1.5 text-[10px] uppercase tracking-widest hover:bg-primary-500 hover:text-black transition shadow-lg rounded-sm"><i class="fas fa-upload"></i> Upload</button>
                            </div>
                            <div class="relative">
                                <textarea id="post-content" rows="6" class="input-luxe w-full p-3 font-body text-sm" placeholder="Escreva os segredos..." required></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <select id="post-access" class="input-luxe w-full p-2 text-sm bg-black cursor-pointer"><option value="aberto">üîì P√∫blico</option><option value="pago">üîê Membros</option></select>
                                <select id="post-section" class="input-luxe w-full p-2 text-sm bg-black cursor-pointer" required><option value="">Carregando...</option></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" id="post-attachment-name" placeholder="Nome do Anexo" class="input-luxe w-full p-2 text-sm">
                                <input type="url" id="post-attachment-link" placeholder="Link do Anexo" class="input-luxe w-full p-2 text-sm">
                            </div>
                            <button type="submit" class="w-full bg-primary-900/40 border border-primary-500/50 text-primary-400 py-3 font-bold uppercase text-xs tracking-widest hover:bg-primary-500 hover:text-black transition">Publicar no Grim√≥rio</button>
                            <p id="post-status" class="text-center text-xs h-4 text-primary-500"></p>
                        </form>

                        <div class="space-y-6">
                            <div class="bg-black/40 p-5 border border-white/5">
                                <h4 class="text-gray-400 text-xs uppercase tracking-widest mb-3"><i class="fas fa-user-plus mr-2"></i>Novo Assinante</h4>
                                <form id="create-account-form" class="flex gap-2 flex-col">
                                    <input type="email" id="new-email" placeholder="Email do Aluno" class="input-luxe p-2 text-sm">
                                    <input type="password" id="new-password" placeholder="Senha Provis√≥ria" class="input-luxe p-2 text-sm">
                                    <select id="account-validity" class="input-luxe p-2 text-sm bg-black"><option value="1">1 M√™s</option><option value="3">3 Meses</option></select>
                                    <button type="submit" class="border border-white/20 text-white py-2 text-xs uppercase hover:bg-white hover:text-black transition">Criar Acesso</button>
                                    <p id="account-status" class="text-xs h-4"></p>
                                </form>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-black/40 p-4 border border-white/5">
                                    <h4 class="text-gray-400 text-xs uppercase tracking-widest mb-3">M√≥dulos</h4>
                                    <form id="create-section-form" class="flex flex-col gap-2 mb-2">
                                        <input type="text" id="section-name" placeholder="Nome" class="input-luxe w-full p-1 text-xs">
                                        <div class="flex gap-2">
                                            <input type="number" id="section-weekly-cap" placeholder="Aulas/Semana" value="3" min="1" max="7" class="input-luxe w-24 p-1 text-xs">
                                            <label class="flex items-center gap-1 text-xs text-gray-400">
                                                <input type="checkbox" id="section-enable-weekly-lock" class="w-3 h-3"> Ativar Trava
                                            </label>
                                        </div>
                                        <button type="submit" class="text-primary-400 hover:text-white bg-primary-900/20 p-1 rounded text-xs"><i class="fas fa-plus"></i> Criar</button>
                                    </form>
                                    <div id="sections-list-admin" class="max-h-24 overflow-y-auto text-xs text-gray-500 custom-scrollbar"></div>
                                </div>
                                <div class="bg-black/40 p-4 border border-white/5">
                                    <h4 class="text-gray-400 text-xs uppercase tracking-widest mb-3">Alunos</h4>
                                    <div id="students-list-admin" class="max-h-32 overflow-y-auto text-xs text-gray-500 space-y-1 custom-scrollbar"></div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <!-- MODAL EDITAR SE√á√ÉO (NOVO) -->
                <div id="edit-section-modal" class="hidden fixed inset-0 z-[85] bg-black/95 flex items-center justify-center p-4">
                    <div class="bg-obsidian border border-white/10 p-8 w-full max-w-sm shadow-2xl">
                        <h2 class="text-xl font-display text-white mb-6 border-b border-white/10 pb-4">Configurar M√≥dulo</h2>
                        <form id="edit-section-form" class="space-y-4">
                            <input type="hidden" id="edit-section-id">
                            <div>
                                <label class="text-gray-400 text-xs uppercase mb-2 block">Nome do M√≥dulo</label>
                                <input type="text" id="edit-section-name" class="input-luxe w-full p-3" required>
                            </div>
                            <div>
                                <label class="text-gray-400 text-xs uppercase mb-2 block">Aulas por Semana</label>
                                <input type="number" id="edit-section-weekly-cap" min="1" max="7" class="input-luxe w-full p-3" value="3" required>
                            </div>
                            <label class="flex items-center gap-3 cursor-pointer bg-primary-900/10 p-3 border border-primary-900/30 rounded">
                                <input type="checkbox" id="edit-section-enable-weekly-lock" class="w-4 h-4 accent-primary-400">
                                <span class="text-sm text-primary-400">Ativar Limite Semanal</span>
                            </label>
                            <p class="text-[10px] text-gray-500 italic">Quando ativado, os alunos poder√£o completar apenas o n√∫mero de aulas definido por semana.</p>
                            <div class="flex gap-3 mt-6">
                                <button type="submit" class="flex-1 bg-primary-900 text-white py-3 text-xs uppercase tracking-widest hover:bg-primary-600 transition rounded">Salvar</button>
                                <button type="button" id="cancel-edit-section-btn" class="flex-1 bg-gray-800 text-white py-3 text-xs uppercase tracking-widest hover:bg-gray-700 transition rounded">Cancelar</button>
                            </div>
                            <p id="edit-section-status" class="text-center mt-4 text-xs text-primary-500 h-4"></p>
                        </form>
                    </div>
                </div>

                <!-- SELETOR DE TRILHAS (HUB DE SE√á√ïES) -->
                <div id="sections-hub" class="mb-20">
                    <div class="text-center mb-12 space-y-4">
                        <i class="fas fa-map-signs text-primary-500 text-2xl"></i>
                        <h3 class="text-4xl font-display text-white">Trilhas de Conhecimento</h3>
                        <p class="text-gray-500 text-sm uppercase tracking-widest">Escolha o mist√©rio que deseja desvendar</p>
                    </div>
                    <div id="sections-cards-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- OS CARDS DAS SE√á√ïES SER√ÉO INJETADOS AQUI PELO JS -->
                        <div class="col-span-full text-center py-20">
                            <i class="fas fa-circle-notch fa-spin text-primary-900 text-4xl"></i>
                        </div>
                    </div>
                </div>

                <!-- VIEW DA TRILHA ESPEC√çFICA (PATH VIEW REFORMULADA) -->
                <div id="active-path-view" class="hidden mb-20 relative">
                    <button id="back-to-hub-btn" class="fixed top-24 left-4 z-30 text-gray-500 hover:text-primary-400 text-xs uppercase tracking-widest flex items-center gap-2 transition bg-black/50 p-2 rounded backdrop-blur border border-white/10">
                        <i class="fas fa-arrow-left"></i> Voltar √†s Trilhas
                    </button>

                    <div class="text-center mb-16 pt-8 relative z-10">
                        <h2 id="path-title" class="text-3xl font-display text-white mb-2"></h2>
                        <span class="text-primary-500 text-[10px] uppercase tracking-[0.3em]">Caminho Inici√°tico</span>
                    </div>

                    <!-- AJUSTE DE LARGURA: MAX-W-LG no Mobile, MAX-W-3XL no Desktop -->
                    <div class="relative w-full md:max-w-3xl max-w-md mx-auto min-h-[600px] px-4 pb-20">
                        <!-- CONTAINER DO SVG E N√ìS -->
                        <div id="path-steps-container" class="path-container-wrapper">
                            <!-- SVG SER√Å GERADO AQUI -->
                        </div>
                        
                        <p id="empty-path-msg" class="hidden text-center text-gray-600 text-sm italic mt-10">O caminho ainda est√° sendo tra√ßado pelos ventos.</p>
                    </div>
                </div>
            </div>

            <div id="profile-view" class="view-container hidden max-w-2xl mx-auto pt-10 px-4">
                 <div class="bg-obsidian border border-primary-900/30 p-8 md:p-12 relative overflow-hidden shadow-2xl">
                     <div class="absolute -top-10 -right-10 text-9xl text-white/5 pointer-events-none"><i class="fas fa-id-card"></i></div>
                     
                     <h2 class="text-3xl font-display text-white mb-2 flex items-center gap-3"><i class="fas fa-hat-wizard text-primary-500"></i> Identidade M√°gica</h2>
                     <p class="text-gray-500 text-xs uppercase tracking-widest mb-10">Como voc√™ ser√° conhecido no Coven</p>
                     
                     <form id="profile-form" class="space-y-8">
                         <div>
                             <label class="block text-primary-400 text-xs uppercase tracking-widest mb-3">Nome de Arte</label>
                             <input type="text" id="profile-display-name" placeholder="Ex: Corvo Noturno" class="input-luxe w-full p-4 font-display text-lg text-white border-b-2 border-primary-900/50 focus:border-primary-400" maxlength="30">
                         </div>

                         <div>
                             <label class="block text-primary-400 text-xs uppercase tracking-widest mb-4">Escolha seu Totem</label>
                             <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                                 <div class="avatar-option"><input type="radio" name="avatar" value="fa-crow" id="av1"><label for="av1"><i class="fas fa-crow"></i></label></div>
                                 <div class="avatar-option"><input type="radio" name="avatar" value="fa-moon" id="av2"><label for="av2"><i class="fas fa-moon"></i></label></div>
                                 <div class="avatar-option"><input type="radio" name="avatar" value="fa-fire" id="av3"><label for="av3"><i class="fas fa-fire"></i></label></div>
                                 <div class="avatar-option"><input type="radio" name="avatar" value="fa-key" id="av4"><label for="av4"><i class="fas fa-key"></i></label></div>
                                 <div class="avatar-option"><input type="radio" name="avatar" value="fa-star" id="av5"><label for="av5"><i class="fas fa-star"></i></label></div>
                                 <div class="avatar-option"><input type="radio" name="avatar" value="fa-ghost" id="av6"><label for="av6"><i class="fas fa-ghost"></i></label></div>
                                 <div class="avatar-option"><input type="radio" name="avatar" value="fa-eye" id="av7"><label for="av7"><i class="fas fa-eye"></i></label></div>
                                 <div class="avatar-option"><input type="radio" name="avatar" value="fa-skull" id="av8"><label for="av8"><i class="fas fa-skull"></i></label></div>
                             </div>
                         </div>

                         <div class="pt-6 border-t border-white/5">
                             <button type="submit" class="w-full bg-primary-900 text-white py-4 font-display font-bold uppercase tracking-[0.2em] hover:bg-primary-500 hover:text-black transition shadow-[0_0_15px_var(--primary-main)]">Salvar Identidade</button>
                             <p id="profile-status" class="text-center text-xs mt-4 h-4"></p>
                         </div>
                     </form>
                 </div>
            </div>

            <div id="sobre-view" class="view-container hidden max-w-5xl mx-auto pt-10 px-4">
                <div class="glass-dark p-8 md:p-16 border-t border-primary-900/50 relative overflow-hidden">
                    <div class="absolute -top-20 -right-20 w-60 h-60 bg-accent/10 rounded-full blur-3xl"></div>
                    
                    <div class="flex flex-col md:flex-row gap-12 items-center relative z-10">
                        <div class="w-full md:w-2/5 relative group">
                            <div class="absolute inset-0 border border-primary-500/20 translate-x-3 translate-y-3 group-hover:translate-x-2 group-hover:translate-y-2 transition duration-500"></div>
                            <img src="https://i.ibb.co/0ymRCF5C/2-DACB7-CC-CE28-4383-BD50-DEB2-C7-A38721.png" class="w-full grayscale hover:grayscale-0 transition duration-700 shadow-2xl relative z-10">
                            <div class="absolute -bottom-5 -left-5 text-3xl text-primary-500 opacity-50 rotate-12"><i class="fas fa-holly-berry text-accent"></i></div>
                        </div>
                        <div class="w-full md:w-3/5 text-gray-300 font-body leading-relaxed space-y-6 text-lg text-justify">
                            <div>
                                <h2 class="text-4xl font-display text-white mb-1 flex items-center gap-3">Leonardo <i class="fas fa-star-of-life text-primary-500 text-xl"></i></h2>
                                <p class="text-primary-500 text-xs uppercase tracking-[0.4em]">Sacerdote de Hekate</p>
                            </div>
                            <p>
                                <span class="text-4xl float-left mr-2 text-primary-600 font-display">N</span>este per√≠odo sagrado, refletimos sobre as encruzilhadas. Minha vida foi dedicada a entender as escolhas que fazemos nas sombras, guiado pela chama da Deusa que renasce.
                            </p>
                            <p>
                                O projeto <strong>O Coven do Corvo</strong> √© meu presente para a comunidade. Aqui, a magia n√£o √© teoria; √© viv√™ncia. Compartilho minha devo√ß√£o e a sabedoria das chaves.
                            </p>
                            <div class="pt-6 border-t border-white/5 flex gap-4 text-2xl text-primary-400">
                                <a href="#" class="hover:text-white transition"><i class="fab fa-instagram"></i></a>
                                <a href="#" class="hover:text-white transition"><i class="fab fa-youtube"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                
    <div id="feed-view" class="view-container hidden max-w-3xl mx-auto pt-10 px-4 mb-20">
        <div class="text-center mb-12 space-y-4">
            <i class="fas fa-scroll text-primary-500 text-3xl animate-pulse"></i>
            <h3 class="text-4xl font-display text-white">Mural do Coven</h3>
            <p class="text-gray-500 text-sm uppercase tracking-widest">Comunicados, press√°gios e mensagens do Sacerdote</p>
        </div>

        <div id="admin-feed-form-container" class="hidden mb-12 bg-obsidian/80 backdrop-blur border border-primary-900/50 p-6 shadow-[0_0_30px_rgba(212,175,55,0.1)] relative overflow-hidden">
            <div class="absolute -right-5 -top-5 text-6xl text-white/5 pointer-events-none"><i class="fas fa-bullhorn"></i></div>
            <h4 class="text-primary-400 font-display text-lg mb-4 flex items-center gap-2"><i class="fas fa-pen"></i> Redigir Comunicado</h4>
            
            <form id="create-feed-post-form" class="space-y-4 relative z-10">
                <textarea id="feed-post-content" class="w-full bg-[#050505] border border-primary-900/30 p-4 text-sm text-gray-300 focus:outline-none focus:border-primary-500 transition-colors resize-none placeholder-gray-700" rows="3" placeholder="O que as sombras sussurram hoje, Sacerdote?" required></textarea>
                <div class="relative">
                    <input type="text" id="feed-post-image" class="w-full bg-[#050505] border border-primary-900/30 p-3 text-sm text-gray-300 pr-24 focus:outline-none focus:border-primary-500 transition-colors" placeholder="Nenhuma imagem selecionada (Opcional)" readonly>
                    <input type="file" id="feed-post-file" accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('feed-post-file').click()" class="absolute right-2 top-1.5 bg-primary-900/50 border border-primary-900 text-primary-400 px-4 py-1.5 text-[10px] uppercase tracking-widest hover:bg-primary-500 hover:text-black transition"><i class="fas fa-image"></i> Adicionar</button>
                </div>
                <button type="submit" class="bg-primary-900 text-white px-8 py-3 text-[10px] font-bold uppercase tracking-widest hover:bg-primary-500 hover:text-black transition-colors w-full sm:w-auto shadow-lg">Publicar no Mural</button>
                <p id="feed-post-status" class="text-xs text-primary-500 hidden mt-2"></p>
            </form>
        </div>

        <div id="feed-posts-container" class="space-y-10">
            <div class="text-center py-20"><i class="fas fa-circle-notch fa-spin text-primary-900 text-4xl"></i></div>
        </div>
    </div>

                </main>

        <footer class="bg-black py-12 text-center border-t border-primary-900/20 relative z-10 overflow-hidden">
            <div class="absolute inset-0 bg-accent/5 pointer-events-none"></div>
            <i class="fas fa-crow text-primary-900 text-2xl mb-4 animate-pulse relative z-10"></i>
            <p class="text-gray-600 text-[10px] uppercase tracking-[0.2em] mb-2 relative z-10">¬© 2025 Coven do Corvo | <script>document.write(activeTheme.name)</script></p>
            <p class="text-gray-800 text-[10px] relative z-10">Desenvolvido nas Sombras</p>
        </footer>

        <div id="login-view" class="view-container hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="w-full max-w-sm relative bg-obsidian p-10 border border-primary-900/30 shadow-[0_0_50px_rgba(139,0,0,0.2)]">
                <button id="close-login-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition"><i class="fas fa-times"></i></button>
                <div class="text-center mb-10">
                    <i class="fas fa-key text-primary-500 text-2xl mb-4"></i>
                    <h2 class="text-2xl font-display text-white tracking-widest flex justify-center items-center gap-2">ACESSO <i class="fas fa-holly-berry text-accent text-sm"></i></h2>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest mt-2">√Årea do Coven do Corvo</p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div class="group">
                        <input type="email" id="login-email" placeholder="EMAIL" class="w-full bg-transparent border-b border-gray-700 p-3 text-center text-white focus:border-primary-400 outline-none transition font-display tracking-wider">
                    </div>
                    <div class="group">
                        <input type="password" id="login-password" placeholder="SENHA" class="w-full bg-transparent border-b border-gray-700 p-3 text-center text-white focus:border-primary-400 outline-none transition font-display tracking-wider">
                    </div>
                    <button type="submit" class="w-full border border-primary-900 text-primary-400 py-4 uppercase text-xs tracking-[0.3em] hover:bg-accent/80 hover:text-white hover:border-accent transition font-bold mt-4">Entrar</button>
                </form>
                <p id="login-error" class="text-center text-red-500 text-xs mt-6 font-display tracking-wider"></p>
            </div>
        </div>

        <div id="post-view" class="view-container hidden fixed inset-0 z-[60] bg-[#030303] overflow-y-auto custom-scrollbar">
    
    <div class="sticky top-0 z-50 bg-[#030303]/80 backdrop-blur-md border-b border-white/5 px-6 py-4 flex justify-between items-center shadow-[0_4px_30px_rgba(0,0,0,0.6)]">
        <button id="back-to-posts-btn" class="text-gray-400 text-[10px] uppercase tracking-[0.3em] hover:text-primary-400 transition flex items-center gap-3 group font-bold">
            <i class="fas fa-arrow-left group-hover:-translate-x-2 transition-transform duration-300"></i> Retornar
        </button>
        <div class="admin-only-controls hidden gap-6">
            <button id="post-view-edit-btn" class="text-gray-500 hover:text-primary-400 transition"><i class="fas fa-pen"></i></button>
            <button id="post-view-delete-btn" class="text-gray-500 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto bg-obsidian/40 relative shadow-2xl mb-24 border-x border-b border-white/5">
        
        <div class="relative w-full h-[40vh] md:h-[55vh] group overflow-hidden border-b border-primary-900/30">
            <div class="absolute inset-0 bg-gradient-to-t from-obsidian via-obsidian/40 to-transparent z-10"></div>
            <img id="post-view-cover-image" class="w-full h-full object-cover grayscale-[40%] group-hover:grayscale-0 transition duration-1000 transform group-hover:scale-105">
        </div>

        <div class="px-8 md:px-20 pb-20 relative z-20 -mt-32 md:-mt-40">
            
            <h1 id="post-view-title" class="text-4xl md:text-6xl font-display text-white text-center mb-6 leading-tight drop-shadow-2xl"></h1>
            
            <div class="flex justify-center items-center gap-4 text-[10px] text-gray-500 uppercase tracking-widest mb-10 border-b border-white/5 pb-8">
                <span class="flex items-center gap-2"><i class="fas fa-eye text-primary-600"></i> <span id="post-view-count">0</span> Leituras</span>
                <i class="fas fa-star-of-life text-[6px] text-primary-900"></i>
                <span class="text-primary-400">Coven do Corvo</span>
            </div>

            <div class="flex justify-center mb-16">
                 <div id="audio-controls" class="inline-flex items-center gap-6 px-8 py-3 border border-primary-900/30 rounded-full cursor-pointer hover:border-primary-400/60 hover:bg-primary-900/10 transition-all duration-300 group bg-black/80 backdrop-blur shadow-lg">
                    <button id="btn-speak" class="flex items-center gap-3 text-primary-500 group-hover:text-primary-300 text-[10px] uppercase font-bold tracking-widest">
                        <i id="btn-speak-icon" class="fas fa-play"></i> <span id="btn-speak-text">Ouvir o Chamado</span>
                    </button>
                    <button id="btn-stop-speak" class="hidden text-red-900 hover:text-red-500 transition"><i class="fas fa-stop"></i></button>
                    <audio id="gemini-audio-player" class="hidden"></audio>
                </div>
            </div>

            <div id="post-view-content" class="prose prose-invert prose-lg max-w-none font-body text-gray-300 leading-loose text-justify selection:bg-primary-900 selection:text-white"></div>

            <div id="post-view-attachment-container" class="hidden mt-20 pt-12 border-t border-primary-900/20 text-center">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-6">Material Complementar</p>
                <a id="post-view-attachment" href="#" target="_blank" class="inline-flex items-center gap-4 bg-transparent border border-primary-500 text-primary-400 px-10 py-4 text-[10px] font-bold uppercase tracking-widest hover:bg-primary-500 hover:text-black transition-all duration-300">
                    <i class="fas fa-download text-sm"></i> Baixar Pergaminho
                </a>
            </div>

            <div class="mt-24 flex justify-center">
                <button id="mark-complete-btn" class="group relative overflow-hidden bg-primary-900 text-white px-12 py-5 font-display font-bold uppercase tracking-[0.2em] text-xs shadow-[0_0_20px_var(--primary-main)] transition-all duration-500 hover:shadow-[0_0_40px_var(--primary-light)] transform hover:-translate-y-1 flex items-center gap-4 rounded-sm">
                    <div class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                    <i class="fas fa-check-circle text-lg relative z-10"></i> 
                    <span class="relative z-10">Concluir & Avan√ßar</span>
                </button>
            </div>
            
            <div id="comments-section" class="mt-28 bg-black/30 p-8 md:p-12 border border-white/5 rounded-sm">
                 <h3 class="text-xl font-display text-white mb-10 flex items-center gap-3 border-b border-primary-900/30 pb-4">
                    <i class="fas fa-feather text-primary-500"></i> Ecos do Coven
                 </h3>
                 
                 <div id="comments-list" class="space-y-6 mb-12"></div>
                 
                 <div id="comment-form-container" class="hidden">
                     <textarea id="comment-input" class="w-full bg-[#050505] border border-primary-900/30 p-5 text-sm mb-4 text-gray-300 focus:outline-none focus:border-primary-500 transition-colors resize-none placeholder-gray-700" rows="3" placeholder="Deixe sua marca neste conhecimento..."></textarea>
                     <button id="submit-comment-btn" class="bg-primary-900/20 border border-primary-900 text-primary-400 px-8 py-3 text-[10px] uppercase font-bold tracking-widest hover:bg-primary-500 hover:text-black transition-colors">Enviar Reflex√£o</button>
                 </div>
                 <p id="comment-login-msg" class="text-center text-gray-600 text-xs italic mt-8">Adentre o santu√°rio para deixar sua oferenda de palavras.</p>
            </div>
        </div>
    </div>
</div>

        <div id="edit-post-view" class="view-container hidden fixed inset-0 z-[70] bg-black p-4 overflow-y-auto">
             <div class="max-w-2xl mx-auto mt-20 bg-obsidian p-8 border border-white/10 shadow-2xl">
                <h2 class="text-xl font-display text-white mb-8 border-b border-white/10 pb-4">Editar Pergaminho</h2>
                <form id="edit-post-form" class="space-y-6">
                    <input type="hidden" id="edit-post-id">
                    <input type="text" id="edit-post-title" class="input-luxe w-full p-3 font-display" required>
                    <div class="relative">
                        <input type="text" id="edit-post-cover-image" class="input-luxe w-full p-3 pr-24" placeholder="Imagem de Capa..." required readonly>
                        <input type="file" id="edit-post-file" accept="image/*" class="hidden">
                        <button type="button" onclick="document.getElementById('edit-post-file').click()" class="absolute right-2 top-2 bg-primary-900 text-white px-4 py-1.5 text-[10px] uppercase tracking-widest hover:bg-primary-500 hover:text-black transition shadow-lg rounded-sm"><i class="fas fa-upload"></i> Upload</button>
                    </div>
                    <div class="relative">
                        <textarea id="edit-post-content" rows="10" class="input-luxe w-full p-3" required></textarea>
                    </div>
                     <div class="grid grid-cols-2 gap-6">
                        <input type="text" id="edit-post-attachment-name" class="input-luxe w-full p-3">
                        <input type="url" id="edit-post-attachment-link" class="input-luxe w-full p-3">
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <select id="edit-post-access" class="input-luxe w-full p-3 bg-black"><option value="pago">Pago</option><option value="aberto">Aberto</option></select>
                        <select id="edit-post-section" class="input-luxe w-full p-3 bg-black"></select>
                    </div>
                    <div class="flex gap-4 mt-8">
                        <button type="submit" class="flex-1 bg-primary-900 text-white py-3 text-xs uppercase tracking-widest hover:bg-primary-600 transition">Salvar</button>
                        <button type="button" id="cancel-edit-btn" class="flex-1 bg-gray-800 text-white py-3 text-xs uppercase tracking-widest hover:bg-gray-700 transition">Cancelar</button>
                    </div>
                    <p id="edit-post-status" class="text-center mt-4 text-xs text-primary-500"></p>
                </form>
             </div>
        </div>

        <div id="manage-student-modal" class="hidden fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4">
            <div class="bg-obsidian border border-white/10 p-8 w-full max-w-md shadow-2xl">
                <div class="flex justify-between mb-6">
                    <div>
                        <span class="text-[10px] text-gray-500 uppercase tracking-widest block">Gerenciando</span>
                        <div class="flex flex-col">
                            <span id="student-modal-email" class="text-primary-400 font-display text-lg"></span>
                            <span id="student-modal-display-name" class="text-gray-500 text-xs italic"></span>
                        </div>
                    </div>
                    <button id="close-student-modal-btn"><i class="fas fa-times text-gray-500 hover:text-white transition"></i></button>
                </div>
                <input type="hidden" id="student-modal-id">
                
                <div class="mb-6 p-4 bg-black/40 border border-primary-900/20 rounded">
                    <p class="text-[10px] text-gray-500 uppercase mb-2">Validade do Acesso</p>
                    <div class="flex items-center justify-between mb-4">
                        <span id="student-expiry-date" class="text-white font-body text-sm"></span>
                        <span id="student-status-badge" class="px-2 py-1 text-[9px] uppercase font-bold rounded bg-gray-800 text-gray-400">Verificando</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <button id="renew-30-btn" class="bg-green-900/30 text-green-400 border border-green-900/50 py-2 text-[10px] uppercase hover:bg-green-900/50 transition">Renovar +30 Dias</button>
                         <button id="renew-90-btn" class="bg-green-900/30 text-green-400 border border-green-900/50 py-2 text-[10px] uppercase hover:bg-green-900/50 transition">Renovar +3 Meses</button>
                         <button id="revoke-btn" class="col-span-2 bg-red-900/30 text-red-400 border border-red-900/50 py-2 text-[10px] uppercase hover:bg-red-900/50 transition font-bold">REVOGAR ACESSO</button>
                    </div>
                </div>

                <p class="text-[10px] text-gray-500 uppercase mb-2">Permiss√µes de M√≥dulos</p>
                <div id="student-modal-sections-list" class="space-y-3 mb-8 max-h-40 overflow-y-auto custom-scrollbar bg-black/50 p-4 border border-white/5"></div>
                <button id="save-student-sections-btn" class="w-full bg-primary-900 text-white py-3 text-xs uppercase tracking-widest hover:bg-primary-500 hover:text-black transition font-bold">Salvar Permiss√µes</button>
                <p id="student-modal-status" class="text-center text-xs mt-4 h-4"></p>
            </div>
        </div>

        <div id="delete-confirm-modal" class="hidden fixed inset-0 z-[90] bg-black/95 flex items-center justify-center">
            <div class="text-center p-10 border border-red-900/30 bg-obsidian shadow-[0_0_50px_rgba(255,0,0,0.1)]">
                <i class="fas fa-exclamation-triangle text-red-900 text-4xl mb-6"></i>
                <h2 id="delete-modal-title" class="text-xl font-display text-white mb-2">Tem certeza?</h2>
                <p class="text-gray-500 text-xs uppercase tracking-widest mb-8">O conhecimento ser√° perdido para sempre.</p>
                <div class="flex justify-center gap-6">
                    <button id="confirm-delete-btn" class="bg-red-900/50 text-red-100 border border-red-900 px-8 py-3 text-xs uppercase hover:bg-red-900 transition">Excluir</button>
                    <button id="cancel-delete-btn" class="bg-gray-800 text-white px-8 py-3 text-xs uppercase hover:bg-gray-700 transition">Cancelar</button>
                </div>
            </div>
        </div>

    </div> <script src="https://player.vimeo.com/api/player.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, query, deleteDoc, updateDoc, setLogLevel, orderBy, increment, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIGURA√á√ÉO FIREBASE ===
        const firebaseConfig = {
          apiKey: "AIzaSyBQXn_dPUivGjfGrWvMwysa-IDX8eXNbCA",
          authDomain: "corvo-4f7e7.firebaseapp.com",
          projectId: "corvo-4f7e7",
          storageBucket: "corvo-4f7e7.firebasestorage.app",
          messagingSenderId: "793120208869",
          appId: "1:793120208869:web:378c37a33c729ff1a6e10c",
          measurementId: "G-V8LBRHPNKT"
        };
        const ADMIN_UID = "9yeLL3aKVXVHKiBNKI3yFiCPMIE3"; 
        const HARDCODED_API_KEY = "AIzaSyA2m-CD-RJOiac90q7p4iql7fYyhlnW1xY"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // === VARI√ÅVEIS ===
        let currentUser = null; 
        let currentUserPermissions = []; 
        let completedPosts = []; // NOVO: ARRAY DE POSTS COMPLETOS PELO USER
        let currentProfile = { displayName: null, avatar: null };
        let itemToDelete = { id: null, type: null }; 
        let allPosts = []; 
        let allSections = []; 
        let allStudents = []; 
        let commentsUnsubscribe = null;
        let activeSectionId = null; // Para saber qual trilha estamos vendo

        // === REFER√äNCIAS ===
        const appRoot = document.getElementById('app-root');
        const introSection = document.getElementById('intro-sequence');
        const loadingSpinner = document.getElementById('loading-spinner');
        const allViews = document.querySelectorAll('.view-container');
        
        // --- INTRO SAFETY ---
        window.forceOpenSite = function() {
            gsap.to(introSection, { opacity: 0, duration: 1, onComplete: () => {
                introSection.style.display = 'none';
                appRoot.style.display = 'block';
                gsap.to(appRoot, { opacity: 1, duration: 1 });
            }});
        };

        window.onload = function() {
            // Failsafe timer
            setTimeout(() => { if(introSection.style.display !== 'none') window.forceOpenSite(); }, 8000); 
            // Normal timer
            setTimeout(() => { window.forceOpenSite(); }, 7500);
        };

        // === NAVEGA√á√ÉO ===
        function showView(viewId) {
            allViews.forEach(view => {
                if (view.classList.contains('fixed')) {
                    if(view.id === viewId) view.style.display = 'flex';
                    else if(!viewId.includes('modal') && !['manage-student-modal','delete-confirm-modal'].includes(view.id)) view.style.display = 'none';
                } else {
                    view.style.display = view.id === viewId ? 'block' : 'none';
                }
            });
            
            // L√ìGICA DE VISUALIZA√á√ÉO DO BLOG (HUB vs TRILHA)
            if(viewId === 'blog-view') {
                 if(!activeSectionId) {
                     // MOSTRAR HUB (CARDS)
                     const hub = document.getElementById('sections-hub');
                     hub.classList.remove('hidden');
                     hub.style.opacity = '1'; // Garante visibilidade
                     document.getElementById('active-path-view').classList.add('hidden');
                 } else {
                     // MOSTRAR TRILHA ATIVA
                     document.getElementById('sections-hub').classList.add('hidden');
                     const pathView = document.getElementById('active-path-view');
                     pathView.classList.remove('hidden');
                     pathView.style.opacity = '1'; // Garante visibilidade
                     pathView.style.transform = 'translateY(0)'; // Reseta posi√ß√£o
                     renderProfessionalPath(activeSectionId); // RE-RENDERIZA PARA ATUALIZAR STATUS VISUAL
                 }
            } else if (viewId !== 'post-view' && viewId !== 'edit-post-view') {
                // S√≥ reseta a se√ß√£o se sair completamente do contexto do blog (ex: Home, Perfil)
                // Se for para 'post-view' ou 'edit-post-view', mant√©m o ID.
                activeSectionId = null; 
            }

            // RESET DE SCROLL GLOBAL
            if(!viewId.includes('modal') && viewId !== 'login-view') window.scrollTo(0,0);
            
            // RESET DE SCROLL DE CONTAINERS INTERNOS (Para post-view fixo)
            const targetEl = document.getElementById(viewId);
            if(targetEl) targetEl.scrollTop = 0;

            document.getElementById('mobile-menu').classList.add('hidden');
        }

        document.querySelectorAll('.internal-link').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget.dataset.view;
                if(target) showView(target);
                stopSpeaking();
            });
        });

        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.remove('hidden');
        });

        // === AUTH & PROFILE ===
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const headerUserName = document.getElementById('header-user-name');
        const headerUserIcon = document.getElementById('header-user-icon');
        const adminPanel = document.getElementById('admin-panel');
        const adminControls = document.querySelectorAll('.admin-only-controls');
        const commentFormContainer = document.getElementById('comment-form-container');
        const commentLoginMsg = document.getElementById('comment-login-msg');

        // PROFILE FORM
        const profileForm = document.getElementById('profile-form');
        const profileDisplayNameInput = document.getElementById('profile-display-name');
        const profileStatus = document.getElementById('profile-status');

        onAuthStateChanged(auth, async (user) => {
            currentUserPermissions = [];
            completedPosts = [];
            currentProfile = { displayName: null, avatar: null };

            if (user) {
                const isAdmin = user.uid === ADMIN_UID;
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (!isAdmin) {
                    if (userDoc.exists()) {
                        const d = userDoc.data();
                        const expires = d.expiresAt.toDate();
                        if (new Date() > expires) { await signOut(auth); return; }
                        currentUserPermissions = d.accessibleSections || [];
                        completedPosts = d.completedPosts || []; // CARREGA POSTS FEITOS
                    } else { await signOut(auth); return; }
                }

                // Load Profile Data
                if(userDoc.exists()) {
                    const d = userDoc.data();
                    currentProfile.displayName = d.displayName || user.email.split('@')[0];
                    currentProfile.avatar = d.avatar || 'fa-user-circle';
                    
                    // UI Updates
                    headerUserName.textContent = currentProfile.displayName;
                    headerUserIcon.className = `fas ${currentProfile.avatar}`;
                    profileDisplayNameInput.value = d.displayName || '';
                    if(d.avatar) {
                        const rb = document.querySelector(`input[name="avatar"][value="${d.avatar}"]`);
                        if(rb) rb.checked = true;
                    }
                }

                currentUser = user;
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                commentFormContainer.classList.remove('hidden');
                commentLoginMsg.classList.add('hidden');
                
                if (isAdmin) {
                    adminPanel.style.display = 'block';
                    adminControls.forEach(el => { el.style.display = 'flex'; el.classList.remove('hidden'); });
                    fetchStudents();
                } else {
                    adminPanel.style.display = 'none';
                    adminControls.forEach(el => el.style.display = 'none');
                }
                // Se for admin, mostra o form do feed. Se n√£o, esconde.
                if (isAdmin) {
                    document.getElementById('admin-feed-form-container').classList.remove('hidden');
                } else {
                    document.getElementById('admin-feed-form-container').classList.add('hidden');
                }
                if(document.getElementById('login-view').style.display === 'flex') showView('blog-view');

            } else {
                currentUser = null;
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
                adminPanel.style.display = 'none';
                adminControls.forEach(el => el.style.display = 'none');
                commentFormContainer.classList.add('hidden');
                commentLoginMsg.classList.remove('hidden');
            }
            fetchSections();
            fetchPosts(); // Carrega os posts para estarem prontos quando abrir uma trilha
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => {
                document.getElementById('login-error').textContent = "Credenciais incorretas.";
            });
        });

        // SAVE PROFILE LOGIC
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            
            profileStatus.textContent = "Gravando nas estrelas...";
            const newName = profileDisplayNameInput.value.trim();
            const checkedAvatar = document.querySelector('input[name="avatar"][value]:checked');
            const newAvatar = checkedAvatar ? checkedAvatar.value : 'fa-user-circle';

            try {
                // Update Firestore
                await updateDoc(doc(db, "users", currentUser.uid), {
                    displayName: newName,
                    avatar: newAvatar
                });
                
                // Update Auth Profile (Standard)
                await updateProfile(currentUser, { displayName: newName, photoURL: newAvatar });
                
                // Update Local UI
                currentProfile.displayName = newName;
                currentProfile.avatar = newAvatar;
                headerUserName.textContent = newName;
                headerUserIcon.className = `fas ${newAvatar}`;
                
                profileStatus.textContent = "Identidade Consagrada!";
                profileStatus.className = "text-center text-xs mt-4 h-4 text-green-400";
                
                setTimeout(() => showView('home-view'), 1500);
            } catch (err) {
                console.error(err);
                profileStatus.textContent = "Erro ao salvar.";
                profileStatus.className = "text-center text-xs mt-4 h-4 text-red-400";
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        loginBtn.addEventListener('click', () => showView('login-view'));
        document.getElementById('close-login-btn').addEventListener('click', () => showView('home-view'));

        // === ADMIN FUNCTIONS ===
        
        // 1. Sections
        const postSectionSelect = document.getElementById('post-section');
        const editPostSectionSelect = document.getElementById('edit-post-section');
        const sectionsListAdmin = document.getElementById('sections-list-admin');
        const sectionsCardsContainer = document.getElementById('sections-cards-container');

        function fetchSections() {
            const q = query(collection(db, "sections"), orderBy("name"));
            onSnapshot(q, (snap) => {
                allSections = [];
                // Admin selects
                postSectionSelect.innerHTML = '<option value="" class="bg-black">Selecione o M√≥dulo</option>';
                editPostSectionSelect.innerHTML = '<option value="" class="bg-black">Selecione o M√≥dulo</option>';
                sectionsListAdmin.innerHTML = '';
                sectionsCardsContainer.innerHTML = '';

                snap.forEach(d => {
                    const sec = { id: d.id, ...d.data() };
                    allSections.push(sec);
                    
                    // Dropdowns de Admin
                    postSectionSelect.add(new Option(sec.name, sec.id));
                    editPostSectionSelect.add(new Option(sec.name, sec.id));
                    
                    // Lista de Admin
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-2 hover:bg-white/5 rounded border-b border-white/5";
                    const lockBadge = sec.enableWeeklyLock ? `<span class="text-[9px] bg-primary-900/50 text-primary-400 px-2 py-1 rounded">3/semana</span>` : '<span class="text-[9px] text-gray-600">Sem limite</span>';
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span>${sec.name}</span>
                                ${lockBadge}
                            </div>
                        </div>
                        <button class="edit-sec-btn text-primary-500 hover:text-primary-400 mr-2 text-xs" data-id="${sec.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="delete-sec-btn text-red-500 hover:text-red-300" data-id="${sec.id}"><i class="fas fa-times"></i></button>
                    `;
                    sectionsListAdmin.appendChild(div);

                          // === RENDERIZAR CARD DA SE√á√ÉO NO HUB (VERS√ÉO MODERNA) ===
                          const card = document.createElement('div');
                          card.className = "group relative bg-[#0a0a0b]/80 backdrop-blur-md border border-primary-900/30 p-10 flex flex-col items-center justify-center text-center min-h-[280px] cursor-pointer overflow-hidden transition-all duration-500 hover:border-primary-400 hover:shadow-[0_0_40px_rgba(212,175,55,0.15)] rounded-sm";
                          card.onclick = () => openPath(sec.id, sec.name);

                          card.innerHTML = `
      <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-primary-900/10 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
      <div class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-primary-500/50 to-transparent transform -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
     
      <i class="fas fa-dungeon text-5xl text-gray-800 mb-6 group-hover:text-primary-400 transition-all duration-500 transform group-hover:scale-110 relative z-10 drop-shadow-md"></i>
     
      <h4 class="text-2xl font-display text-gray-200 mb-4 group-hover:text-white transition-colors duration-500 relative z-10 tracking-wide">${sec.name}</h4>
     
      <div class="h-[1px] w-8 bg-primary-900/50 mb-5 group-hover:w-16 group-hover:bg-primary-400 transition-all duration-500 relative z-10"></div>
     
      <p class="text-[9px] text-gray-500 uppercase tracking-[0.2em] relative z-10 group-hover:text-primary-400 transition-colors">
          Adentrar o Mist√©rio <i class="fas fa-arrow-right ml-1 opacity-0 group-hover:opacity-100 transition-all transform group-hover:translate-x-2"></i>
      </p>
     `;
                          sectionsCardsContainer.appendChild(card);
                });
            });
        }
        
        document.getElementById('create-section-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('section-name').value;
            const weeklyCap = parseInt(document.getElementById('section-weekly-cap').value) || 3;
            const enableWeeklyLock = document.getElementById('section-enable-weekly-lock').checked;
            
            if(name) { 
                await addDoc(collection(db, "sections"), {
                    name, 
                    weeklyCap,
                    enableWeeklyLock,
                    createdAt: new Date()
                }); 
                document.getElementById('create-section-form').reset();
                document.getElementById('section-enable-weekly-lock').checked = false;
            }
        });

        // === LOGICA DE TRILHA PROFISSIONAL (SVG SNAKE) ===
        const sectionsHub = document.getElementById('sections-hub');
        const activePathView = document.getElementById('active-path-view');
        const pathTitle = document.getElementById('path-title');
        const backToHubBtn = document.getElementById('back-to-hub-btn');

        function openPath(sectionId, sectionName) {
            activeSectionId = sectionId;
            pathTitle.textContent = sectionName;
            
            // Troca a view
            gsap.to(sectionsHub, { opacity: 0, duration: 0.3, onComplete: () => {
                sectionsHub.classList.add('hidden');
                activePathView.classList.remove('hidden');
                gsap.fromTo(activePathView, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5 });
                renderProfessionalPath(sectionId);
            }});
        }

        backToHubBtn.addEventListener('click', () => {
             activeSectionId = null;
             gsap.to(activePathView, { opacity: 0, duration: 0.3, onComplete: () => {
                activePathView.classList.add('hidden');
                sectionsHub.classList.remove('hidden');
                gsap.fromTo(sectionsHub, { opacity: 0 }, { opacity: 1, duration: 0.5 });
            }});
        });

        function renderProfessionalPath(sectionId) {
            const container = document.getElementById('path-steps-container');
            container.innerHTML = '';
            
            // Filtra e ordena
            const pathPosts = allPosts.filter(p => p.sectionId === sectionId).sort((a,b) => a.createdAt - b.createdAt);

            if(pathPosts.length === 0) {
                document.getElementById('empty-path-msg').classList.remove('hidden');
                container.style.height = 'auto'; // Reseta altura se vazio
                return;
            }
            document.getElementById('empty-path-msg').classList.add('hidden');

            const icons = ['fa-scroll', 'fa-flask', 'fa-book-skull', 'fa-star', 'fa-feather-alt'];
            
            // === AJUSTES RESPONSIVOS (MOBILE/DUOLINGO STYLE) ===
            const containerRect = container.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const isMobile = window.innerWidth < 768; // md breakpoint
            
            // For√ßa recalculo seguro da largura dispon√≠vel
            // container.clientWidth ignora barras de rolagem, √© mais seguro que getBoundingClientRect().width em alguns casos
            const availableWidth = Math.min(container.clientWidth, window.innerWidth - 32); 
            
            // No mobile, a curva deve ser muito mais suave para n√£o sair da tela
            // AUMENTANDO O ESPA√áAMENTO PARA DAR MAIS RESPIRO
            const spacing = isMobile ? 180 : 220; 
            
            // Amplitude segura: (Largura / 2) - (Raio do N√≥ + Padding de seguran√ßa)
            // N√≥ tem 70px (raio 35), margem segura ~40
            const maxSafeAmplitude = (availableWidth / 2) - 45; 
            
            // Se for mobile, usa a amplitude reduzida para n√£o estourar a tela.
            // Se for desktop, usa 120 (amplitude mais larga) para aproveitar o espa√ßo extra.
            const amplitude = isMobile ? Math.min(60, maxSafeAmplitude) : 120; 
            
            const centerX = availableWidth / 2; // Centraliza baseado na largura real dispon√≠vel
            
            // === C√ÅLCULO DIN√ÇMICO DE ALTURA ===
            // Multiplica o n¬∫ de posts pelo espa√ßo e adiciona uma margem segura no final
            const totalHeight = (pathPosts.length * spacing) + 250; 
            container.style.height = totalHeight + 'px'; // For√ßa o container a crescer

            // Cria o SVG Container
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("class", "path-svg-line");
            svg.style.height = totalHeight + 'px';
            container.appendChild(svg);

            let pathD = "";
            let prevX = centerX;
            let prevY = 40;

            // RECUPERA √öLTIMO ITEM COMPLETADO PARA ANIMA√á√ÉO
            const justCompletedId = sessionStorage.getItem('just_completed_post');
            sessionStorage.removeItem('just_completed_post'); // Limpa ap√≥s usar

            pathPosts.forEach((p, index) => {
                // L√ìGICA DE BLOQUEIO DUOLINGO
                const isAdmin = currentUser && currentUser.uid === ADMIN_UID;
                const hasSectionAccess = isAdmin || (currentUserPermissions && currentUserPermissions.includes(sectionId));
                const isPaid = p.access === 'pago';
                
                let isCompleted = completedPosts.includes(p.id);
                // Opcional: Se for admin, pode querer ver como completo ou n√£o. Deixamos natural.

                let isLocked = false;
                
                if (isPaid && !hasSectionAccess) {
                    isLocked = true; // Sem permiss√£o de compra
                } else {
                    // L√≥gica Sequencial + Limite Semanal
                    if (currentUser) {
                         if (index > 0 && !completedPosts.includes(pathPosts[index-1].id) && !isAdmin) {
                            isLocked = true;
                        }
                        
                        // NOVO: Verifica limite semanal se a se√ß√£o tiver ativado
                        if(!isLocked && !isAdmin) {
                            const section = allSections.find(s => s.id === sectionId);
                            if(section && section.enableWeeklyLock) {
                                const weekKey = getWeekKey();
                                const weeklyStats = (currentUser && currentUser.uid) ? allStudents.find(u => u.id === currentUser.uid)?.weeklyStats : {};
                                
                                if(weeklyStats && weeklyStats[sectionId] && weeklyStats[sectionId][weekKey]) {
                                    const stats = weeklyStats[sectionId][weekKey];
                                    if(stats.completed >= stats.cap && !isCompleted) {
                                        isLocked = true;
                                    }
                                }
                            }
                        }
                    } else {
                        // Visitante vendo conte√∫do aberto = LIBERADO
                        isLocked = false;
                    }
                }

                // Estado Visual
                let statusClass = "status-locked";
                if (isCompleted) statusClass = "status-completed";
                else if (!isLocked) statusClass = "status-active";

                // Se acabou de completar este, for√ßa visual de completo mas com anima√ß√£o
                let animationClass = "";
                if (p.id === justCompletedId) {
                    animationClass = "celebration-unlock";
                    // Garante status completed visualmente
                    statusClass = "status-completed"; 
                }

                // AVATAR LOGIC: Primeiro n√≥ n√£o-bloqueado e n√£o-completo
                // OU se acabamos de completar um, o avatar vai para o PR√ìXIMO (index + 1) se existir
                let showAvatar = false;
                if (!isLocked && !isCompleted) showAvatar = true;
                
                // Se acabamos de completar este post, o avatar n√£o deve estar nele, mas no pr√≥ximo.
                // Mas o loop varre sequencialmente. O pr√≥ximo item cair√° no `if` acima naturalmente.

                // Coordenadas Sinuosas (Senoide)
                const y = 40 + (index * spacing);
                const x = centerX + Math.sin(index * 1.5) * amplitude; // Curva matem√°tica

                // Desenha a linha SVG at√© aqui
                if (index === 0) {
                    pathD += `M ${x} ${y}`;
                } else {
                    // Curva B√©zier Suave (Quadr√°tica)
                    const cpY = (prevY + y) / 2;
                    pathD += ` Q ${prevX} ${cpY}, ${x} ${y}`; 
                }
                prevX = x;
                prevY = y;

                // Renderiza o N√≥ HTML posicionado absolutamente
                const nodeWrapper = document.createElement('div');
                nodeWrapper.className = 'path-node-wrapper group'; // Adicionado 'group' para hover
                nodeWrapper.style.left = x + 'px';
                nodeWrapper.style.top = y + 'px';

                // √çcone rotativo
                const icon = icons[index % icons.length];
                const iconHtml = isLocked ? '<i class="fas fa-lock"></i>' : (isCompleted ? '<i class="fas fa-check"></i>' : `<i class="fas ${icon}"></i>`);

                // Crown for active
                const crown = (!isLocked && !isCompleted) ? '<i class="fas fa-crown crown-icon"></i>' : '';

                // AVATAR HTML
                const avatarHtml = showAvatar ? `
                    <div class="path-avatar-float">
                        <div class="path-avatar-icon"><i class="fas fa-crow"></i></div>
                        <div class="path-avatar-arrow">‚ñº</div>
                    </div>
                ` : '';

                // TOOLTIP HTML (Para locked)
                let tooltipText = "Selado.<br>Complete o rito anterior.";
                const section = allSections.find(s => s.id === sectionId);
                if(section && section.enableWeeklyLock && !isAdmin && currentUser) {
                    const weekKey = getWeekKey();
                    const userData = allStudents.find(u => u.id === currentUser.uid);
                    if(userData && userData.weeklyStats && userData.weeklyStats[sectionId] && userData.weeklyStats[sectionId][weekKey]) {
                        const stats = userData.weeklyStats[sectionId][weekKey];
                        tooltipText = `Limite atingido!<br>${stats.completed}/${stats.cap} aulas esta semana.<br>Volta segunda!`;
                    }
                }
                const lockedTooltipHtml = isLocked ? `
                    <div class="locked-tooltip">
                        <i class="fas fa-key mb-1 block text-lg"></i>
                        ${tooltipText}
                    </div>
                ` : '';

                // ONCLICK PARA MOBILE LOCKED
                const clickAction = isLocked 
                    ? "alert('Este conhecimento est√° selado. Complete o passo anterior para obter a chave.')" 
                    : `openPostFromPath('${p.id}')`;

                nodeWrapper.innerHTML = `
                    ${avatarHtml}
                    ${crown}
                    <div class="game-node ${statusClass} ${animationClass}" onclick="${clickAction}">
                        ${iconHtml}
                    </div>
                    ${lockedTooltipHtml}
                    <div class="node-label">${p.title}</div>
                    ${!isLocked && !isCompleted ? '<div class="stars-container"><div class="absolute w-full h-full animate-spin-slow opacity-30"><i class="fas fa-star absolute top-0 left-1/2 text-xs text-yellow-500"></i><i class="fas fa-star absolute bottom-0 left-1/2 text-xs text-yellow-500"></i></div></div>' : ''}
                `;
                container.appendChild(nodeWrapper);
            });

            // Finaliza o desenho da linha SVG
            const pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
            pathEl.setAttribute("d", pathD);
            pathEl.setAttribute("stroke", "#333"); // Cor da trilha inativa
            pathEl.setAttribute("stroke-width", "8");
            pathEl.setAttribute("fill", "none");
            pathEl.setAttribute("stroke-linecap", "round");
            
            // (Opcional: Poderia adicionar uma segunda linha 'stroke' colorida cobrindo at√© o ponto atual, mas isso requer calcular o comprimento do path)
            
            svg.appendChild(pathEl);
        }

        // Wrapper global para o onclick inline funcionar com module
        window.openPostFromPath = function(id) {
            openPost(id);
        };


        // 2. Students
        const studentsListAdmin = document.getElementById('students-list-admin');
        function fetchStudents() {
            onSnapshot(query(collection(db, "users")), (snap) => {
                allStudents = [];
                studentsListAdmin.innerHTML = '';
                snap.forEach(d => {
                    if(d.id === ADMIN_UID) return;
                    const st = { id: d.id, ...d.data() };
                    allStudents.push(st);
                    
                    // Show Name if exists, else Email
                    const displayLabel = st.displayName ? `${st.displayName} (${st.email.split('@')[0]})` : st.email;
                    
                    const div = document.createElement('div');
                    div.className = "flex justify-between p-2 border-b border-white/5 hover:bg-white/5";
                    div.innerHTML = `<span class="truncate w-32" title="${st.email}">${displayLabel}</span><button class="manage-student-btn text-primary-400" data-id="${st.id}"><i class="fas fa-cog"></i></button>`;
                    studentsListAdmin.appendChild(div);
                });
            });
        }
        
        document.getElementById('create-account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('new-email').value;
            const pass = document.getElementById('new-password').value;
            const months = parseInt(document.getElementById('account-validity').value);
            const status = document.getElementById('account-status');
            status.textContent = "Gerando...";
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const exp = new Date(); exp.setMonth(exp.getMonth() + months);
                await setDoc(doc(db, "users", cred.user.uid), { email, createdAt: new Date(), expiresAt: exp, accessibleSections: [] });
                status.textContent = "Acesso Criado!"; status.className = "text-green-400 text-xs";
                document.getElementById('create-account-form').reset();
            } catch(e) { status.textContent = "Erro: " + e.code; status.className = "text-red-400 text-xs"; }
        });

        // 3. Posts
        const createPostForm = document.getElementById('create-post-form');
        const postStatus = document.getElementById('post-status');

        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            postStatus.textContent = "Enviando ao Grim√≥rio...";
            const secSelect = document.getElementById('post-section');
            const secName = secSelect.options[secSelect.selectedIndex].text;
            
            try {
                await addDoc(collection(db, "posts"), {
                    title: document.getElementById('post-title').value,
                    coverImage: document.getElementById('post-cover-image').value,
                    content: document.getElementById('post-content').value,
                    attachmentName: document.getElementById('post-attachment-name').value || null,
                    attachmentURL: document.getElementById('post-attachment-link').value || null,
                    access: document.getElementById('post-access').value,
                    sectionId: secSelect.value,
                    sectionName: secName,
                    createdAt: new Date(),
                    viewCount: 0
                });
                postStatus.textContent = "Publicado!"; createPostForm.reset();
            } catch(e) { postStatus.textContent = "Falha no ritual."; }
        });

        function fetchPosts() {
            onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "asc")), (snap) => {
                allPosts = [];
                snap.forEach(d => allPosts.push({ id: d.id, ...d.data() }));
                
                // Se estivermos vendo uma trilha, atualiza ela em tempo real
                if(activeSectionId) {
                    renderProfessionalPath(activeSectionId);
                }
            });
        }

        // === VIEW POST & COMMENTS & COMPLETION ===
        const postViewTitle = document.getElementById('post-view-title');
        const postViewContent = document.getElementById('post-view-content');
        const postViewCover = document.getElementById('post-view-cover-image');
        const postViewCount = document.getElementById('post-view-count');
        const postViewAttachContainer = document.getElementById('post-view-attachment-container');
        const postViewAttachLink = document.getElementById('post-view-attachment');

        // COMMENTS ELEMENTS
        const commentsList = document.getElementById('comments-list');
        const commentInput = document.getElementById('comment-input');
        const submitCommentBtn = document.getElementById('submit-comment-btn');
        let currentPostId = null;

        async function openPost(id) {
            loadingSpinner.classList.remove('hidden');
            const ref = doc(db, "posts", id);
            const snap = await getDoc(ref);
            
            if(snap.exists()) {
                const p = snap.data();
                if(p.access === 'pago') {
                    const allowed = (currentUser && currentUser.uid === ADMIN_UID) || (currentUser && currentUserPermissions.includes(p.sectionId));
                    if(!allowed) { 
                        loadingSpinner.classList.add('hidden'); 
                        alert("Este conhecimento est√° selado."); return; 
                    }
                }

                currentPostId = id;
                await updateDoc(ref, { viewCount: increment(1) });
                
                postViewTitle.textContent = p.title;
                postViewCount.textContent = (p.viewCount || 0) + 1;
                postViewCover.src = p.coverImage;
                postViewContent.innerHTML = formatText(p.content);
                
                if(p.attachmentURL) {
                    postViewAttachLink.href = p.attachmentURL;
                    postViewAttachContainer.classList.remove('hidden');
                } else {
                    postViewAttachContainer.classList.add('hidden');
                }

                // CONFIGURA BOT√ÉO DE CONCLUS√ÉO
                const completeBtn = document.getElementById('mark-complete-btn');
                
                // Mas para user normal:
                if(completedPosts.includes(id)) {
                    completeBtn.classList.remove('bg-primary-900', 'text-white', 'hover:scale-105');
                    completeBtn.classList.add('bg-green-500/20', 'text-green-400', 'border', 'border-green-500/50', 'cursor-default');
                    completeBtn.innerHTML = '<i class="fas fa-check-double"></i> Ritual J√° Conclu√≠do';
                    completeBtn.onclick = null;
                } else {
                    completeBtn.classList.add('bg-primary-900', 'text-white', 'hover:scale-105');
                    completeBtn.classList.remove('bg-green-500/20', 'text-green-400', 'border', 'border-green-500/50', 'cursor-default');
                    completeBtn.innerHTML = '<i class="fas fa-check-circle"></i> Concluir Leitura & Avan√ßar';
                    completeBtn.onclick = markPostComplete;
                }

                document.getElementById('post-view-edit-btn').onclick = () => openEdit(id);
                document.getElementById('post-view-delete-btn').onclick = () => confirmDel(id, 'post');

                loadComments(id);
                stopSpeaking();
                showView('post-view');
            }
            loadingSpinner.classList.add('hidden');
        }

        // FUN√á√ÉO DE MARCAR COMO COMPLETO
        async function markPostComplete() {
            if(!currentUser || !currentPostId) return;
            
            // Busca o post atual para pegar a se√ß√£o
            const post = allPosts.find(p => p.id === currentPostId);
            if(!post) return;
            
            // Pega a se√ß√£o para verificar se tem limite semanal
            const section = allSections.find(s => s.id === post.sectionId);
            
            const btn = document.getElementById('mark-complete-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consagrando...';
            
            try {
                // Se a se√ß√£o tem limite semanal, precisa rastrear
                if(section && section.enableWeeklyLock) {
                    const userRef = doc(db, "users", currentUser.uid);
                    const userData = await getDoc(userRef);
                    
                    let weeklyStats = userData.data().weeklyStats || {};
                    const sectionId = post.sectionId;
                    const weekKey = getWeekKey(); // Chave √∫nica para cada semana
                    
                    if(!weeklyStats[sectionId]) weeklyStats[sectionId] = {};
                    if(!weeklyStats[sectionId][weekKey]) {
                        weeklyStats[sectionId][weekKey] = { completed: 0, cap: section.weeklyCap || 3 };
                    }
                    
                    // Se j√° completou o limite desta semana
                    if(weeklyStats[sectionId][weekKey].completed >= weeklyStats[sectionId][weekKey].cap) {
                        btn.innerHTML = originalText;
                        alert(`‚è≥ Limite semanal atingido!\n\nVoc√™ j√° completou ${weeklyStats[sectionId][weekKey].cap} aulas esta semana.\n\nVoltaremos segunda-feira com 3 novas aulas para voc√™!`);
                        return;
                    }
                    
                    // Incrementa o contador semanal
                    weeklyStats[sectionId][weekKey].completed += 1;
                    
                    await updateDoc(userRef, {
                        completedPosts: arrayUnion(currentPostId),
                        weeklyStats: weeklyStats
                    });
                } else {
                    // Sem limite semanal, apenas registra
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        completedPosts: arrayUnion(currentPostId)
                    });
                }
                
                // Atualiza Localmente
                if(!completedPosts.includes(currentPostId)) completedPosts.push(currentPostId);
                
                // ARMAZENA O ID PARA A ANIMA√á√ÉO QUANDO VOLTAR
                sessionStorage.setItem('just_completed_post', currentPostId);

                // UI Feedback
                btn.className = "bg-yellow-500 text-black px-10 py-5 rounded-full font-display font-bold uppercase tracking-widest text-sm shadow-[0_0_30px_#FFD700] transform scale-110 transition";
                btn.innerHTML = '<i class="fas fa-star"></i> S√°bio! Avan√ßando...';
                
                setTimeout(() => {
                    showView('blog-view'); // Volta para a trilha para ver o desbloqueio
                }, 1500);

            } catch(e) {
                console.error(e);
                alert("Erro ao salvar progresso.");
                btn.innerHTML = originalText;
            }
        }

        // LOAD COMMENTS (Client-side Sort Fix)
        function loadComments(postId) {
            if(commentsUnsubscribe) commentsUnsubscribe();
            
            const q = query(collection(db, "comments"), where("postId", "==", postId));
            
            commentsUnsubscribe = onSnapshot(q, (snap) => {
                commentsList.innerHTML = '';
                
                if(snap.empty) {
                    commentsList.innerHTML = '<p class="text-gray-600 text-xs italic">O sil√™ncio reina. Seja o primeiro a falar.</p>';
                    return;
                }
                
                let comments = [];
                snap.forEach(d => comments.push({ id: d.id, ...d.data() }));
                
                comments.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });
                
                comments.forEach(c => {
                    const isOwner = currentUser && (currentUser.uid === c.userId || currentUser.uid === ADMIN_UID);
                    const displayName = c.userName || (c.userEmail ? c.userEmail.split('@')[0] : 'An√¥nimo');
                    const displayIcon = c.userAvatar ? `<i class="fas ${c.userAvatar} mr-1 text-primary-500"></i>` : '';

                    const div = document.createElement('div');
                    div.className = "bg-black/40 border border-white/5 p-4 rounded relative";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-primary-500 text-[10px] uppercase font-bold tracking-widest flex items-center">${displayIcon} ${displayName}</span>
                            <span class="text-gray-600 text-[9px]">${c.createdAt?.toDate ? c.createdAt.toDate().toLocaleDateString() : ''}</span>
                        </div>
                        <p class="text-gray-300 text-sm font-body leading-relaxed">${c.content}</p>
                        ${isOwner ? `<button onclick="deleteComment('${c.id}')" class="absolute bottom-2 right-2 text-red-900 hover:text-red-500 transition text-[10px]"><i class="fas fa-trash"></i></button>` : ''}
                    `;
                    commentsList.appendChild(div);
                });
            });
        }

        // ADD COMMENT
        submitCommentBtn.addEventListener('click', async () => {
            if(!currentUser || !currentPostId) return;
            const txt = commentInput.value.trim();
            if(!txt) return;

            submitCommentBtn.disabled = true;
            submitCommentBtn.textContent = "Enviando...";

            try {
                await addDoc(collection(db, "comments"), {
                    postId: currentPostId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentProfile.displayName || currentUser.email.split('@')[0],
                    userAvatar: currentProfile.avatar || 'fa-user-circle',
                    content: txt,
                    createdAt: new Date()
                });
                commentInput.value = '';
            } catch(e) { console.error(e); alert("Erro ao comentar."); }
            submitCommentBtn.disabled = false;
            submitCommentBtn.textContent = "Enviar Coment√°rio";
        });

        // DELETE COMMENT
        window.deleteComment = async function(id) {
            if(confirm("Deseja apagar este registro?")) {
                await deleteDoc(doc(db, "comments", id));
            }
        };

        // HELPER: Obter chave √∫nica da semana (segunda-feira como in√≠cio)
        function getWeekKey() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Ajusta para segunda
            const monday = new Date(today.setDate(diff));
            return monday.toISOString().split('T')[0]; // YYYY-MM-DD
        }

        function formatText(txt) {
            if(!txt) return '';
            let t = txt.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            t = t.replace(/!\[(.*?)\]\((.*?)\)/g, `<div class="my-10"><img src="$2" class="w-full rounded-sm border border-primary-900/30 shadow-lg"><p class="text-center text-[10px] text-gray-500 mt-2 uppercase tracking-widest">$1</p></div>`);
            t = t.replace(/\*\*(.*?)\*\*/g, '<strong class="text-primary-400 font-bold">$1</strong>');
            t = t.replace(/##(.*?)##/g, '<span class="text-accent italic border-b border-accent/50">$1</span>');
            t = t.replace(/^### (.*$)/gim, '<h3 class="text-2xl text-white font-display mt-8 mb-4 border-l-2 border-primary-500 pl-4">$1</h3>');
            return t.replace(/\n/g, '<br>');
        }

        // === EDIT & DELETE POSTS ===
        const editPostForm = document.getElementById('edit-post-form');
        async function openEdit(id) {
            const snap = await getDoc(doc(db, "posts", id));
            if(snap.exists()) {
                const p = snap.data();
                document.getElementById('edit-post-id').value = id;
                document.getElementById('edit-post-title').value = p.title;
                document.getElementById('edit-post-cover-image').value = p.coverImage;
                document.getElementById('edit-post-content').value = p.content;
                document.getElementById('edit-post-attachment-name').value = p.attachmentName||'';
                document.getElementById('edit-post-attachment-link').value = p.attachmentURL||'';
                document.getElementById('edit-post-access').value = p.access;
                document.getElementById('edit-post-section').value = p.sectionId;
                showView('edit-post-view');
            }
        }

        editPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-post-id').value;
            const secSelect = document.getElementById('edit-post-section');
            const secName = secSelect.options[secSelect.selectedIndex].text;
            
            await updateDoc(doc(db, "posts", id), {
                title: document.getElementById('edit-post-title').value,
                coverImage: document.getElementById('edit-post-cover-image').value,
                content: document.getElementById('edit-post-content').value,
                attachmentName: document.getElementById('edit-post-attachment-name').value,
                attachmentURL: document.getElementById('edit-post-attachment-link').value,
                access: document.getElementById('edit-post-access').value,
                sectionId: secSelect.value,
                sectionName: secName
            });
            openPost(id); 
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
             if(document.getElementById('post-view').style.display === 'block') showView('post-view');
             else showView('blog-view');
        });

        function confirmDel(id, type) {
            itemToDelete = {id, type};
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        }
        // === EDIT SECTION (NOVO) ===
        const editSectionForm = document.getElementById('edit-section-form');
        const editSectionModal = document.getElementById('edit-section-modal');
        
        async function openEditSection(sectionId) {
            const section = allSections.find(s => s.id === sectionId);
            if(!section) return;
            
            document.getElementById('edit-section-id').value = sectionId;
            document.getElementById('edit-section-name').value = section.name;
            document.getElementById('edit-section-weekly-cap').value = section.weeklyCap || 3;
            document.getElementById('edit-section-enable-weekly-lock').checked = section.enableWeeklyLock || false;
            editSectionModal.classList.remove('hidden');
        }
        
        editSectionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sectionId = document.getElementById('edit-section-id').value;
            const status = document.getElementById('edit-section-status');
            
            try {
                status.textContent = "Salvando...";
                await updateDoc(doc(db, "sections", sectionId), {
                    name: document.getElementById('edit-section-name').value,
                    weeklyCap: parseInt(document.getElementById('edit-section-weekly-cap').value),
                    enableWeeklyLock: document.getElementById('edit-section-enable-weekly-lock').checked
                });
                status.textContent = "Salvo com sucesso!";
                status.className = "text-center mt-4 text-xs text-green-400 h-4";
                setTimeout(() => {
                    editSectionModal.classList.add('hidden');
                }, 1000);
            } catch(err) {
                console.error(err);
                status.textContent = "Erro ao salvar.";
                status.className = "text-center mt-4 text-xs text-red-400 h-4";
            }
        });
        
        document.getElementById('cancel-edit-section-btn').addEventListener('click', () => {
            editSectionModal.classList.add('hidden');
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            if(itemToDelete.type === 'post') {
                await deleteDoc(doc(db, "posts", itemToDelete.id));
                showView('blog-view');
            } else if (itemToDelete.type === 'section') {
                await deleteDoc(doc(db, "sections", itemToDelete.id));
            }
            document.getElementById('delete-confirm-modal').style.display = 'none';
        });
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        });

        // === GLOBAL LISTENERS ===
        appRoot.addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            
            // Buttons inside list
            if(e.target.closest('.edit-btn')) openEdit(e.target.closest('.edit-btn').dataset.id);
            if(e.target.closest('.del-btn')) confirmDel(e.target.closest('.del-btn').dataset.id, 'post');
            if(e.target.closest('.delete-sec-btn')) confirmDel(e.target.closest('.delete-sec-btn').dataset.id, 'section');
            if(e.target.closest('.edit-sec-btn')) openEditSection(e.target.closest('.edit-sec-btn').dataset.id);
            
            // Student
            if(e.target.closest('.manage-student-btn')) {
                openManageStudent(e.target.closest('.manage-student-btn').dataset.id);
            }
        });

        const manageModal = document.getElementById('manage-student-modal');
        const studentExpiryDate = document.getElementById('student-expiry-date');
        const studentStatusBadge = document.getElementById('student-status-badge');
        let currentManagingUser = null;

        async function openManageStudent(sid) {
            // Re-fetch latest data for accuracy
            const docSnap = await getDoc(doc(db, "users", sid));
            if(!docSnap.exists()) return;
            const st = { id: docSnap.id, ...docSnap.data() };
            currentManagingUser = st;

            document.getElementById('student-modal-email').textContent = st.email;
            document.getElementById('student-modal-id').value = sid;
            document.getElementById('student-modal-display-name').textContent = st.displayName || 'Sem Nome M√°gico';
            
            // Handle Date Display
            const expDate = st.expiresAt.toDate();
            studentExpiryDate.textContent = expDate.toLocaleDateString('pt-BR');
            
            if(expDate > new Date()) {
                studentStatusBadge.textContent = "ATIVO";
                studentStatusBadge.className = "px-2 py-1 text-[9px] uppercase font-bold rounded bg-green-900/50 text-green-400";
            } else {
                studentStatusBadge.textContent = "EXPIRADO";
                studentStatusBadge.className = "px-2 py-1 text-[9px] uppercase font-bold rounded bg-red-900/50 text-red-400";
            }

            // Populate Sections
            const list = document.getElementById('student-modal-sections-list');
            list.innerHTML = '';
            
            allSections.forEach(sec => {
                const checked = st.accessibleSections && st.accessibleSections.includes(sec.id);
                const label = document.createElement('label');
                label.className = "flex items-center gap-3 text-gray-300 text-sm p-2 hover:bg-white/5 cursor-pointer border-b border-white/5";
                label.innerHTML = `<input type="checkbox" value="${sec.id}" ${checked?'checked':''} class="accent-primary-400 w-4 h-4"> ${sec.name}`;
                list.appendChild(label);
            });
            manageModal.style.display = 'flex';
        }
        
        // --- Access Buttons Logic ---
        async function updateAccessTime(monthsToAdd) {
            if(!currentManagingUser) return;
            const ref = doc(db, "users", currentManagingUser.id);
            
            let newDate;
            if (monthsToAdd === 0) {
                 // Revoke (set to yesterday)
                 newDate = new Date();
                 newDate.setDate(newDate.getDate() - 1);
            } else {
                // If expired, start from today. If active, add to existing date.
                const currentExp = currentManagingUser.expiresAt.toDate();
                const baseDate = (currentExp > new Date()) ? currentExp : new Date();
                
                newDate = new Date(baseDate);
                // Simple logic: treat 1 month as 30 days roughly for JS simplicity or use setMonth
                if(monthsToAdd === 1) newDate.setDate(newDate.getDate() + 30); // Using days is safer for "months" sometimes
                if(monthsToAdd === 3) newDate.setDate(newDate.getDate() + 90);
            }
            
            await updateDoc(ref, { expiresAt: newDate });
            openManageStudent(currentManagingUser.id); // Refresh modal
        }

        document.getElementById('renew-30-btn').addEventListener('click', () => updateAccessTime(1));
        document.getElementById('renew-90-btn').addEventListener('click', () => updateAccessTime(3));
        document.getElementById('revoke-btn').addEventListener('click', () => {
            if(confirm("Tem certeza que deseja bloquear o acesso deste aluno imediatamente?")) updateAccessTime(0);
        });

        document.getElementById('save-student-sections-btn').addEventListener('click', async () => {
            const sid = document.getElementById('student-modal-id').value;
            const checks = document.querySelectorAll('#student-modal-sections-list input:checked');
            const newSecs = Array.from(checks).map(c => c.value);
            await updateDoc(doc(db, "users", sid), { accessibleSections: newSecs });
            manageModal.style.display = 'none';
        });
        document.getElementById('close-student-modal-btn').addEventListener('click', () => manageModal.style.display = 'none');


        // === AI TEXT & AUDIO ===

        const audioPlayer = document.getElementById('gemini-audio-player');
        const btnSpeak = document.getElementById('btn-speak');
        const btnSpeakText = document.getElementById('btn-speak-text');
        const btnStopSpeak = document.getElementById('btn-stop-speak');

        function base64ToBuffer(b64) {
            const str = window.atob(b64);
            const b = new Uint8Array(str.length);
            for(let i=0; i<str.length; i++) b[i] = str.charCodeAt(i);
            return b.buffer;
        }
        function makeWav(data) {
            const b = new ArrayBuffer(44 + data.byteLength);
            const v = new DataView(b);
            const w = (o,s)=> { for(let i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); };
            w(0,'RIFF'); v.setUint32(4, 36+data.byteLength, true); w(8,'WAVE');
            w(12,'fmt '); v.setUint32(16,16,true); v.setUint16(20,1,true);
            v.setUint16(22,1,true); v.setUint32(24,24000,true); v.setUint32(28,48000,true);
            v.setUint16(32,2,true); v.setUint16(34,16,true); w(36,'data');
            v.setUint32(40,data.byteLength,true);
            new Uint8Array(b, 44).set(new Uint8Array(data));
            return b;
        }

        async function speak() {
            if(!audioPlayer.paused && audioPlayer.src) { audioPlayer.pause(); btnSpeakText.textContent = "Continuar"; return; }
            if(audioPlayer.paused && audioPlayer.src) { audioPlayer.play(); btnSpeakText.textContent = "Pausar"; return; }

            const key = HARDCODED_API_KEY || geminiApiKeyInput.value;
            if(!key) return alert("API Key necess√°ria.");

            btnSpeakText.textContent = "Carregando...";
            const txt = document.getElementById('post-view-content').innerText.substring(0, 4000);
            
            try {
                const req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: txt }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
                    })
                });
                const res = await req.json();
                const pcm = base64ToBuffer(res.candidates[0].content.parts[0].inlineData.data);
                const wav = makeWav(pcm);
                const blob = new Blob([wav], { type: 'audio/wav' });
                audioPlayer.src = URL.createObjectURL(blob);
                
                audioPlayer.onplay = () => { btnSpeakText.textContent = "Pausar"; btnStopSpeak.classList.remove('hidden'); };
                audioPlayer.onended = stopSpeaking;
                audioPlayer.play();
            } catch(e) { console.error(e); btnSpeakText.textContent = "Ouvir"; }
        }

        function stopSpeaking() {
            if(audioPlayer.src) { audioPlayer.pause(); audioPlayer.src = ""; }
            btnSpeakText.textContent = "Ouvir o Chamado"; btnStopSpeak.classList.add('hidden');
        }

        btnSpeak.addEventListener('click', speak);
        btnStopSpeak.addEventListener('click', stopSpeaking);
        document.getElementById('back-to-posts-btn').addEventListener('click', () => {
            stopSpeaking();
            showView('blog-view'); // Volta para a trilha pois estamos no contexto do blog
        });

        // Adiciona listener para redimensionamento da janela para ajustar a trilha
        window.addEventListener('resize', () => {
            if(activeSectionId && !document.getElementById('active-path-view').classList.contains('hidden')) {
                renderProfessionalPath(activeSectionId);
            }
        });

        // ==========================================
        // üîÆ SISTEMA DO MURAL / FEED DO COVEN üîÆ
        // ==========================================
        const feedForm = document.getElementById('create-feed-post-form');
        const feedContainer = document.getElementById('feed-posts-container');
        let allFeedPosts = [];

        // 1. Criar Postagem (Apenas Sacerdote)
        if(feedForm) {
            feedForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if(!currentUser || currentUser.uid !== ADMIN_UID) return;

                const content = document.getElementById('feed-post-content').value;
                const image = document.getElementById('feed-post-image').value;
                const status = document.getElementById('feed-post-status');
                
                status.textContent = "Gravando comunicado nas estrelas...";
                status.classList.remove('hidden');

                try {
                    await addDoc(collection(db, "feed_posts"), {
                        content: content,
                        image: image || null,
                        authorId: currentUser.uid,
                        createdAt: new Date(),
                        likes: [] // Array de UIDs de quem curtiu
                    });
                    feedForm.reset();
                    status.textContent = "Publicado com sucesso!";
                    setTimeout(() => status.classList.add('hidden'), 3000);
                } catch(err) {
                    console.error(err);
                    status.textContent = "Erro ao publicar.";
                }
            });
        }

        // 2. Buscar Postagens em Tempo Real
        function fetchFeedPosts() {
            const q = query(collection(db, "feed_posts"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                feedContainer.innerHTML = '';
                allFeedPosts = [];

                if(snap.empty) {
                    feedContainer.innerHTML = '<p class="text-center text-gray-600 text-sm italic">O mural aguarda os sussurros do Sacerdote.</p>';
                    return;
                }

                snap.forEach(docSnap => {
                    const post = { id: docSnap.id, ...docSnap.data() };
                    allFeedPosts.push(post);
                    renderFeedPost(post);
                });
            });
        }

        // 3. Renderizar cada Post no HTML
        function renderFeedPost(post) {
            const isLiked = currentUser && post.likes && post.likes.includes(currentUser.uid);
            const likeCount = post.likes ? post.likes.length : 0;
            const dateStr = post.createdAt?.toDate ? post.createdAt.toDate().toLocaleDateString('pt-BR', {day: '2-digit', month: 'long', hour:'2-digit', minute:'2-digit'}) : '';

            const div = document.createElement('div');
            div.className = "bg-obsidian border border-white/5 p-6 shadow-lg relative group";
            
            // Deleta o post se for admin (sempre vis√≠vel)
            const deleteBtn = (currentUser && currentUser.uid === ADMIN_UID) 
                ? `<button onclick="deleteFeedPost('${post.id}')" class="absolute top-3 right-3 bg-red-900/30 border border-red-900/50 text-red-500 hover:bg-red-900 hover:text-red-300 transition-all px-3 py-2 text-xs font-bold tracking-widest flex items-center gap-1 rounded-sm shadow-lg"><i class="fas fa-trash"></i> Apagar</button>` : '';

            const imgHtml = post.image ? `<img src="${post.image}" class="w-full h-auto max-h-96 object-cover border border-primary-900/30 mb-4 grayscale-[20%] hover:grayscale-0 transition duration-500">` : '';

            div.innerHTML = `
                ${deleteBtn}
                <div class="flex items-center gap-3 mb-4 border-b border-white/5 pb-4">
                    <div class="w-10 h-10 rounded-full bg-primary-900/20 border border-primary-500 flex items-center justify-center text-primary-400">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div>
                        <h5 class="text-white font-display text-sm tracking-widest">Sacerdote Leonardo</h5>
                        <p class="text-[9px] text-gray-500 uppercase tracking-widest">${dateStr}</p>
                    </div>
                </div>
                
                ${imgHtml}
                
                <div class="text-gray-300 font-body text-sm leading-relaxed mb-6 whitespace-pre-wrap">${post.content}</div>
                
                <div class="flex items-center gap-6 border-t border-white/5 pt-4">
                    <button onclick="toggleFeedLike('${post.id}')" class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest transition-colors ${isLiked ? 'text-primary-500' : 'text-gray-500 hover:text-primary-400'}">
                        <i class="${isLiked ? 'fas' : 'far'} fa-fire"></i> ${likeCount} Chamas
                    </button>
                    <button onclick="toggleCommentsUI('${post.id}')" class="flex items-center gap-2 text-[10px] text-gray-500 font-bold uppercase tracking-widest hover:text-white transition-colors">
                        <i class="far fa-comment"></i> Comentar
                    </button>
                </div>

                <div id="comments-ui-${post.id}" class="hidden mt-6 bg-black/40 p-4 border border-white/5">
                    <div id="feed-comments-list-${post.id}" class="space-y-4 mb-4 max-h-48 overflow-y-auto custom-scrollbar pr-2"></div>
                    
                    ${currentUser ? `
                    <div class="flex gap-2">
                        <input type="text" id="feed-comment-input-${post.id}" class="w-full bg-[#050505] border border-primary-900/30 p-3 text-xs text-white focus:border-primary-500 transition-colors" placeholder="Deixe sua resposta...">
                        <button onclick="addFeedComment('${post.id}')" class="bg-primary-900 text-white px-4 hover:bg-primary-500 hover:text-black transition"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    ` : '<p class="text-[9px] text-gray-600 uppercase text-center italic">Acesse o santu√°rio para comentar.</p>'}
                </div>
            `;
            
            feedContainer.appendChild(div);
            loadFeedComments(post.id); // J√° carrega os coment√°rios em background
        }

        // 4. Intera√ß√µes: Curtir/Chamas (Precisa estar logado)
        window.toggleFeedLike = async function(postId) {
            if(!currentUser) { alert("Voc√™ precisa estar conectado para acender essa chama!"); return; }
            
            const postRef = doc(db, "feed_posts", postId);
            const post = allFeedPosts.find(p => p.id === postId);
            
            if(post.likes && post.likes.includes(currentUser.uid)) {
                await updateDoc(postRef, { likes: post.likes.filter(id => id !== currentUser.uid) });
            } else {
                const newLikes = post.likes ? [...post.likes, currentUser.uid] : [currentUser.uid];
                await updateDoc(postRef, { likes: newLikes });
            }
        }

        // 5. Exibir/Ocultar UI de Coment√°rios
        window.toggleCommentsUI = function(postId) {
            const ui = document.getElementById(`comments-ui-${postId}`);
            if(!ui) return;
            ui.classList.toggle('hidden');
        }

        // 6. Enviar Coment√°rio
        window.addFeedComment = async function(postId) {
            if(!currentUser) return;
            const input = document.getElementById(`feed-comment-input-${postId}`);
            if(!input) return;
            const text = input.value.trim();
            if(!text) return;

            input.disabled = true;
            try {
                await addDoc(collection(db, "feed_comments"), {
                    feedPostId: postId,
                    userId: currentUser.uid,
                    userName: currentProfile.displayName || currentUser.email.split('@')[0],
                    content: text,
                    createdAt: new Date()
                });
                input.value = '';
            } catch(err) { console.error(err); }
            input.disabled = false;
        }

        // 7. Carregar Coment√°rios
        function loadFeedComments(postId) {
            const q = query(collection(db, "feed_comments"), where("feedPostId", "==", postId));
            onSnapshot(q, (snap) => {
                const listDiv = document.getElementById(`feed-comments-list-${postId}`);
                if(!listDiv) return;
                
                listDiv.innerHTML = '';
                let comments = [];
                snap.forEach(d => comments.push({id: d.id, ...d.data()}));
                comments.sort((a,b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));

                comments.forEach(c => {
                    const isOwner = currentUser && (currentUser.uid === c.userId || currentUser.uid === ADMIN_UID);
                    listDiv.innerHTML += `
                        <div class="relative group">
                            <p class="text-[10px] text-primary-500 font-bold uppercase mb-1">${c.userName} <span class="text-gray-600 lowercase font-normal">${c.createdAt?.toDate().toLocaleDateString()}</span></p>
                            <p class="text-gray-300 text-xs font-body leading-relaxed">${c.content}</p>
                            ${isOwner ? `<button onclick="deleteFeedComment('${c.id}')" class="absolute top-0 right-0 text-red-900 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times text-[10px]"></i></button>` : ''}
                        </div>
                    `;
                });
            });
        }

        // 8. Deletar (S√≥ para o Sacerdote)
        window.deleteFeedPost = async function(postId) {
            if(confirm("Apagar este aviso dos registros?")) {
                await deleteDoc(doc(db, "feed_posts", postId));
            }
        }
        window.deleteFeedComment = async function(commentId) {
            if(confirm("Apagar este eco?")) {
                await deleteDoc(doc(db, "feed_comments", commentId));
            }
        }

        // Inicializar a busca dos feeds assim que abrir a p√°gina
        fetchFeedPosts();

        // ==========================================
        // ‚òÅÔ∏è UPLOAD DE IMAGENS AUTOM√ÅTICO (IMGBB) ‚òÅÔ∏è
        // ==========================================
        const IMGBB_API_KEY = "c3d86c0c95606522cb1f5faa1be29231";

        async function uploadImageToImgBB(file, urlInputId, buttonEl) {
            if (!file) return;
            
            // Guarda o texto original do bot√£o para voltar depois
            const originalHTML = buttonEl.innerHTML;
            
            // Estado de carregamento
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subindo...';
            buttonEl.disabled = true;
            buttonEl.classList.add('opacity-50', 'cursor-not-allowed');

            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Sucesso! Preenche o campo de texto com o link gerado
                    document.getElementById(urlInputId).value = data.data.url;
                    buttonEl.innerHTML = '<i class="fas fa-check"></i> Conclu√≠do!';
                    buttonEl.classList.remove('bg-primary-900', 'text-white');
                    buttonEl.classList.add('bg-green-600', 'text-white', 'border-green-500');
                } else {
                    throw new Error("Falha no retorno da API");
                }
            } catch (error) {
                console.error("Erro na magia de upload:", error);
                alert("Sacerdote, as sombras bloquearam o upload. Tente novamente.");
                buttonEl.innerHTML = '<i class="fas fa-times"></i> Erro';
            } finally {
                // Restaura o bot√£o depois de 2.5 segundos
                setTimeout(() => { 
                    buttonEl.innerHTML = originalHTML; 
                    buttonEl.disabled = false; 
                    buttonEl.className = buttonEl.className.replace(/bg-green-600|border-green-500|opacity-50|cursor-not-allowed/g, '');
                }, 2500);
            }
        }

        // Conectando os inputs de arquivo aos campos de texto
        const createPostFile = document.getElementById('post-cover-file');
        if(createPostFile) {
            createPostFile.addEventListener('change', function() {
                uploadImageToImgBB(this.files[0], 'post-cover-image', this.nextElementSibling);
            });
        }

        const editPostFile = document.getElementById('edit-post-file');
        if(editPostFile) {
            editPostFile.addEventListener('change', function() {
                uploadImageToImgBB(this.files[0], 'edit-post-cover-image', this.nextElementSibling);
            });
        }

        const feedPostFile = document.getElementById('feed-post-file');
        if(feedPostFile) {
            feedPostFile.addEventListener('change', function() {
                uploadImageToImgBB(this.files[0], 'feed-post-image', this.nextElementSibling);
            });
        }

        // Dica extra: Limpar a imagem do Feed quando a postagem for feita com sucesso
        const formFeedCriar = document.getElementById('create-feed-post-form');
        if(formFeedCriar) {
            formFeedCriar.addEventListener('submit', () => {
                setTimeout(() => {
                    document.getElementById('feed-post-image').value = '';
                }, 1000); // Limpa o link da imagem quando limpar o form
            });
        }

    </script>
</body>
</html>
